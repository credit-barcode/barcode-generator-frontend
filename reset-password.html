<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>重設密碼</title>
  <style>
    body { font-family: Arial, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #f4f4f4; margin: 0; }
    .container { background: #fff; padding: 2rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); width: 90vw; max-width: 400px; text-align: center; }
    .form-group { margin-bottom: 1rem; text-align: left; }
    label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
    input { width: 100%; padding: 0.75rem; font-size: 1rem; border-radius: 6px; border: 1px solid #ccc; }
    button { width: 100%; padding: 0.75rem; font-size: 1rem; border: none; border-radius: 6px; background-color: #4CAF50; color: white; cursor: pointer; font-weight: bold; }
    button:hover { background-color: #45a049; }
    #message { margin-top: 1rem; min-height: 1.2rem; font-weight: bold; }
    .success { color: green; }
    .error { color: red; }
  </style>
</head>
<body>
  <div class="container">
    <h3>設定您的新密碼</h3>
    <div id="resetForm">
      <div class="form-group">
        <label for="newPassword">新密碼</label>
        <input type="password" id="newPassword" placeholder="至少8位，含大小寫英文及特殊符號">
      </div>
      <div class="form-group">
        <label for="confirmPassword">確認新密碼</label>
        <input type="password" id="confirmPassword" placeholder="請再次輸入新密碼">
      </div>
      <button id="submitBtn">確定重設</button>
    </div>
    <p id="message"></p>
    <a id="loginLink" href="/" style="display: none; margin-top: 1rem;">返回登入頁面</a>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const submitBtn = document.getElementById('submitBtn');
      const newPasswordInput = document.getElementById('newPassword');
      const confirmPasswordInput = document.getElementById('confirmPassword');
      const messageEl = document.getElementById('message');
      const loginLink = document.getElementById('loginLink');
      const resetForm = document.getElementById('resetForm');

      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token');

      if (!token) {
        messageEl.textContent = '錯誤：此連結無效或已損壞。';
        messageEl.className = 'error';
        resetForm.style.display = 'none';
        loginLink.style.display = 'block';
        return;
      }

      submitBtn.addEventListener('click', () => {
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        messageEl.textContent = '';
        
        if (newPassword !== confirmPassword) {
          messageEl.textContent = '兩次輸入的密碼不相符。';
          messageEl.className = 'error';
          return;
        }
        const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]).{8,}$/;
        if (!passwordRegex.test(newPassword)) {
            messageEl.textContent = '新密碼格式不符 (至少8位，含大小寫英文及特殊符號)。';
            messageEl.className = 'error';
            return;
        }

        messageEl.textContent = '處理中...';
        messageEl.className = '';

        // ▼▼▼ 【核心修正】將請求路徑和 body 修改為符合整合路由的格式 ▼▼▼
        fetch('/api/auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'resetPassword', // 附上 action
            token: token,
            newPassword: newPassword
          })
        })
        // ▲▲▲ 【核心修正】 ▲▲▲
        .then(response => response.json().then(json => {
            if (!response.ok) throw new Error(json.message);
            return json;
        }))
        .then(data => {
          if (data.success) {
              messageEl.textContent = data.message;
              messageEl.className = 'success';
              resetForm.style.display = 'none';
              loginLink.style.display = 'block';
          }
        })
        .catch(err => {
          messageEl.textContent = '錯誤：' + err.message;
          messageEl.className = 'error';
        });
      });
    });
  </script>
</body>
</html>