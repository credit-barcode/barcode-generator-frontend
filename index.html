<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>ç¹³è²»æ¢ç¢¼</title>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; padding: 1rem; font-family: Arial, sans-serif; display: flex; flex-direction: column; align-items: center; background-color: #f4f4f4; }
    h2, h3 { text-align: center; }
    p { font-size: 1rem; font-weight: bold; color: red; text-align: center; margin-bottom: 1rem; }
    form { width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 0.5rem; margin: 0 auto 1rem auto; text-align: center; }
    input, select, button { font-size: 1rem; padding: 0.5rem; width: 100%; border-radius: 6px; border: 1px solid #ccc; }
    button { background-color: #4CAF50; color: white; border: none; cursor: pointer; font-weight: bold; }
    button:hover { background-color: #45a049; }
    button:disabled { background-color: #cccccc; cursor: not-allowed; }
    .preview-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 1rem; width: 100%; max-width: 1200px; margin: 1rem auto; }
    .qr-wrapper { display: flex; flex-direction: column; background-color: #fff; padding: 28px 24px 20px 24px; border: 1px solid #ccc; border-radius: 12px; width: 500px; margin: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: relative; }
    .qr-wrapper .serial-number { position: absolute; top: 18px; right: 24px; background-color: #4CAF50; color: white; font-weight: bold; font-size: 16px; border-radius: 50%; min-width: 32px; height: 32px; display: flex; justify-content: center; align-items: center; padding: 0 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    .qr-wrapper .barcode-title { font-weight: bold; text-align: center; margin-bottom: 24px; font-size: 24px; }
    .qr-wrapper .barcode-reminder { color:orange; font-weight:bold; font-size:16px; text-align:center; margin-top:18px; }
    @media screen and (max-width: 600px) { .qr-wrapper { width: 100%; margin: 10px 0; } }
    #loginBox, #registerBox, #forgotBox, #verifyBox, #legacyVerifyBox { width: 90vw; max-width: 340px; margin: 40px auto; padding: 24px 16px; border: 1px solid #ccc; border-radius: 12px; box-shadow: 0 2px 8px #0001; background: #fff; display: flex; flex-direction: column; align-items: center; }
    #loginBox h3, #registerBox h3, #forgotBox h3, #verifyBox h3, #legacyVerifyBox h3 { margin: 0 0 18px 0; font-size: 1.3rem; text-align: center; font-weight: bold; }
    #loginBox .form-group, #registerBox .form-group, #profileBox .form-group, #verifyBox .form-group, #legacyVerifyBox .form-group { width: 100%; margin-bottom: 16px; text-align: left; position: relative; }
    #loginBox input, #registerBox input, #forgotBox input, #verifyBox input, #legacyVerifyBox input { width: 100%; padding: 12px; font-size: 1.1rem; }
    #loginBox button, #registerBox button, #forgotBox button, #verifyBox button, #legacyVerifyBox button { width: 100%; padding: 12px; font-size: 1.1rem; margin-top: 4px; }
    #loginMsg, #registerMsg, #forgotMsg, #verifyMsg, #legacyVerifyMsg { color: red; margin-top: 12px; text-align: center; font-size: 1rem; min-height: 1.2rem; }
    #mainApp, #previewPage { display: none; width: 100%; max-width: 800px; margin: 0 auto; text-align: center; padding: 1rem; }
    .preview-actions { display: flex; justify-content: center; align-items: center; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
    .download-button-container { text-align: center; margin-top: 0; }
    #downloadAllBtn { width: auto !important; min-width: 150px; display: none; padding: 8px 24px; font-size: 1rem; background-color: #dc3545; margin: 0 auto; }
    #backToGeneratorBtn { width: auto; padding: 8px 24px; font-size: 1rem; background-color: #6c757d; margin-top: 0; }
    #customAlert { display: none; position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; z-index: 9999; background: rgba(0,0,0,0.4); justify-content: center; align-items: center; }
    #customAlertBox { background: #fff; padding: 32px 24px 28px 24px; border-radius: 16px; max-width: 90vw; min-width: 320px; box-shadow: 0 4px 15px rgba(0,0,0,0.18); text-align: center; font-family: inherit; }
    #customAlertMsg { margin-bottom: 18px; font-size: 1.15em; line-height: 1.6; }
    #customAlertButtons { display: flex; justify-content: center; gap: 1.5em; align-items: center; margin-top: 0.5em; }
    #customAlertBox button { padding: 10px 38px; font-size: 1.1em; border-radius: 8px; border: none; font-weight: bold; margin: 0 0.2em; transition: background 0.2s; cursor: pointer; }
    #customAlertBox #confirmBtn { background: #e53935; color: #fff; }
    #customAlertBox #cancelBtn { background: #757d87; color: #fff; }
    #customAlertBox button:not(#confirmBtn):not(#cancelBtn) { background-color: #4CAF50; color: white; }
    .download-alert-title { color: #e53935; font-size: 1.25em; font-weight: bold; margin-bottom: 0.5em; letter-spacing: 1px; }
    .download-alert-desc { color: #222; font-size: 1.08em; margin-bottom: 0.5em; font-weight: 500; }
    .download-alert-list-title { font-size: 1.1em; font-weight: bold; margin: 1em 0 0.5em 0; letter-spacing: 1px; }
    .download-alert-checkboxes { display: flex; flex-direction: column; align-items: flex-start; gap: 0.5em; margin: 0.5em auto 1.2em auto; font-size: 1em; width: fit-content; }
    .download-alert-checkboxes label { display: flex; align-items: center; gap: 0.5em; font-size: 1em; font-weight: 500; cursor: pointer; user-select: none; }
    .download-alert-checkboxes input[type="checkbox"] { width: 18px; height: 18px; accent-color: #e53935; flex-shrink: 0; }
    @media (max-width: 480px) { #customAlertBox { min-width: 90vw; padding: 18px 4vw 18px 4vw; } .download-alert-checkboxes label { font-size: 0.98em; } #customAlertBox button { font-size: 1em; padding: 8px 0; width: 44vw; } }
    #profileBox { display: none; width: 90vw; max-width: 400px; margin: 40px auto; padding: 24px; border: 1px solid #ccc; border-radius: 12px; box-shadow: 0 2px 8px #0001; background: #fff; flex-direction: column; align-items: center; }
    #profileBox h3 { margin: 0 0 24px 0; font-size: 1.3rem; text-align: center; font-weight: bold; }
    #profileBox .form-group label { display: block; font-weight: bold; margin-bottom: 6px; }
    #profileBox .form-group span { background-color: #eee; padding: 8px; display: inline-block; word-break: break-all; border-radius: 4px; width: 100%;}
    #profileBox .button-group { display: flex; gap: 1rem; width: 100%; margin-top: 10px; }
    #profileMsg { color: red; margin-top: 12px; text-align: left; font-size: 0.9rem; width:100%; }
    .input-hint { display: block; width: 100%; text-align: left; font-size: 0.8rem; color: #6c757d; margin-top: 4px; margin-bottom: 0; padding-left: 2px; }
    .uppercase-input { text-transform: uppercase; }
    #adminPanel, #userAdminPanel { display: none; width: 100%; max-width: 1000px; margin: 2rem auto; padding: 1.5rem; background: #fff; border: 1px solid #ccc; border-radius: 12px; flex-direction: column; }
    #adminPanel h3, #userAdminPanel h3 { margin: 0 0 1.5rem 0; }
    #serialTable, #userTable { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
    #serialTable th, #serialTable td, #userTable th, #userTable td { border: 1px solid #ddd; padding: 0.75rem; text-align: center; vertical-align: middle;}
    #serialTable th, #userTable th { background-color: #f2f2f2; }
    #serialTable input, #userTable input[type="number"] { width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; text-align: center; }
    #userTable input[type="checkbox"] { width: 20px; height: 20px; }
    #serialTable .delete-row-btn { background-color: #f44336; color: white; border: none; padding: 6px 10px; cursor: pointer; border-radius: 4px; }
    .admin-button-group { display: flex; flex-direction: column; gap: 0.5rem; width: 100%; margin-top: 1rem; }
  </style>
</head>
<body>

  <div id="loginBox"><h3>è«‹å…ˆç™»å…¥</h3><div class="form-group"><input id="loginAccount" type="text" placeholder="å¸³è™Ÿ" /></div><div class="form-group"><input type="password" id="loginPassword" placeholder="å¯†ç¢¼" /></div><button id="loginBtn">ç™»å…¥</button><button type="button" id="showRegisterBtn" style="background-color:#6c757d;">è¨»å†Š</button><button type="button" id="showForgotBtn" style="background-color:#ffc107;color:#212529;">å¿˜è¨˜å¯†ç¢¼</button><div id="loginMsg"></div></div>
  <div id="registerBox" style="display:none;"><h3>è¨»å†Šæ–°å¸³è™Ÿ</h3><div class="form-group"><input id="registerAccount" type="text" placeholder="å¸³è™Ÿ" /></div><div class="form-group"><input type="password" id="registerPassword" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" /><small class="input-hint">å¯†ç¢¼è‡³å°‘8ä½ï¼Œå«å¤§å°å¯«è‹±æ–‡åŠä¸€å€‹ç‰¹æ®Šç¬¦è™Ÿ</small></div><div class="form-group"><input id="registerEmail" type="email" placeholder="ä¿¡ç®±" /></div><div class="form-group"><input id="registerSerial" type="text" placeholder="è¨»å†Šç¢¼" /></div><button id="registerBtn">ç¢ºå®šè¨»å†Š</button><button id="registerBackToLoginBtn" style="background-color:#6c757d;">è¿”å›ç™»å…¥</button><div id="registerMsg"></div></div>
  <div id="verifyBox" style="display:none;"><h3>è«‹é©—è­‰æ‚¨çš„ä¿¡ç®±</h3><p id="verifyInfoMsg" style="color:#333; font-weight:normal; font-size: 0.9em; line-height: 1.5; margin-bottom: 18px;"></p><div class="form-group"><input id="verifyCode" type="text" placeholder="6 ä½æ•¸é©—è­‰ç¢¼" maxlength="6" /></div><button id="verifyBtn">é©—è­‰</button><button type="button" id="resendCodeBtn" style="background-color:#ffc107; color:#212529; font-size: 0.9em;">æ²’æœ‰æ”¶åˆ°ï¼Ÿé‡æ–°å¯„é€é©—è­‰ç¢¼</button><button id="verifyBackToLoginBtn" style="background-color:#6c757d;">è¿”å›ç™»å…¥</button><div id="verifyMsg"></div></div>
  <div id="legacyVerifyBox" style="display:none;"><h3>ç³»çµ±æ›´æ–° - è«‹é©—è­‰ä¿¡ç®±</h3><p style="color:#333; font-weight:normal; font-size: 0.9em; line-height: 1.5; margin-bottom: 18px;">ç‚ºæå‡å¸³æˆ¶å®‰å…¨ï¼Œæˆ‘å€‘éœ€è¦æ‚¨å®Œæˆä¿¡ç®±é©—è­‰ã€‚è«‹ç¢ºèªæˆ–ä¿®æ”¹æ‚¨çš„ä¿¡ç®±ï¼Œæˆ‘å€‘å°‡ç™¼é€ä¸€çµ„é©—è­‰ç¢¼çµ¦æ‚¨ã€‚</p><div class="form-group"><input id="legacyEmail" type="email" placeholder="è«‹ç¢ºèªæˆ–è¼¸å…¥æ–°ä¿¡ç®±" /></div><button id="legacySendBtn">ç™¼é€é©—è­‰ç¢¼</button><button id="legacyLaterBtn" style="background-color:#6c757d;">ç¨å¾Œå†èªª</button><div id="legacyVerifyMsg"></div></div>
  <div id="forgotBox" style="display:none;"><h3>å¿˜è¨˜å¯†ç¢¼</h3><div class="form-group" style="margin-bottom:8px;"><input id="forgotAccount" type="text" placeholder="å¸³è™Ÿ" /></div><div class="form-group"><input id="forgotEmail" type="email" placeholder="è¨»å†Šä¿¡ç®±" /></div><button id="forgotSendBtn">å¯„é€å¯†ç¢¼æç¤º</button><button id="forgotBackBtn" style="background-color:#6c757d;">è¿”å›</button><div id="forgotMsg"></div></div>
  <div id="profileBox" style="display:none;"><h3>æœƒå“¡è³‡æ–™</h3><div class="form-group"><label>å¸³è™Ÿ</label><span id="profileAccount"></span></div><div class="form-group"><label for="currentPassword">ç›®å‰çš„å¯†ç¢¼</label><input type="password" id="currentPassword" placeholder="è«‹è¼¸å…¥æ‚¨ç›®å‰çš„å¯†ç¢¼ä»¥é€²è¡Œé©—è­‰" required></div><div class="form-group"><label for="profilePassword">æ–°å¯†ç¢¼ (ä¸ä¿®æ”¹è«‹ç•™ç©º)</label><input type="password" id="profilePassword" placeholder="è«‹è¼¸å…¥æ–°å¯†ç¢¼"><small class="input-hint">å¯†ç¢¼è‡³å°‘8ä½ï¼Œå«å¤§å°å¯«è‹±æ–‡åŠä¸€å€‹ç‰¹æ®Šç¬¦è™Ÿ</small></div><div class="form-group"><label for="profileEmail">è¨»å†Šä¿¡ç®± (æš«ä¸å¯ä¿®æ”¹)</label><input type="email" id="profileEmail" placeholder="è«‹è¼¸å…¥æ‚¨çš„ä¿¡ç®±" disabled></div><div class="form-group"><label>å‰©é¤˜ä¸‹è¼‰é¡åº¦</label><span id="profileQuota"></span></div><div class="form-group"><label>è¨»å†Šæ—¥æœŸ</label><span id="profileRegisterDate"></span></div><div class="form-group"><label>æœ€å¾Œä¿®æ”¹æ—¥æœŸ</label><span id="profileLastModified"></span></div><div id="profileMsg"></div><div class="button-group"><button id="saveProfileBtn">å„²å­˜è®Šæ›´</button><button id="cancelProfileBtn" style="background-color:#6c757d;">è¿”å›ä¸»ç•«é¢</button></div></div>
  <div id="mainApp"><div style="text-align: right; width: 100%; max-width: 800px; margin: 0 auto 1rem auto;"><button id="userAdminBtn" style="width: auto; padding: 8px 16px; background-color: #17a2b8; display: none; margin-right: 1rem;">ä½¿ç”¨è€…ç®¡ç†</button><button id="adminBtn" style="width: auto; padding: 8px 16px; background-color: #ff9800; display: none; margin-right: 1rem;">ç®¡ç†è¨»å†Šç¢¼</button><button id="showProfileBtn" style="width: auto; padding: 8px 16px; background-color: #007bff; margin-right: 1rem;">æœƒå“¡è³‡æ–™</button><button id="logoutBtn" style="width: auto; padding: 8px 16px; background-color: #6c757d;">ç™»å‡º</button></div><div style="text-align: center; line-height: 1.8; border: 2px dashed red; padding: 10px; border-radius: 8px; margin-bottom: 1rem;"><p style="margin-bottom: 0.0em;">ğŸš€ <strong>ä½¿ç”¨é¢¨éšªæé†’</strong></p><p style="margin: 0;">ä¿¡ç”¨å¡æ¢ç¢¼ç”¢ç”Ÿå™¨æœ‰å¯èƒ½æœƒç™¼ç”Ÿ</p><p style="margin: 0;">æ¢ç¢¼æƒå¾—éä½†å¯¦éš›æ²’å…¥å¸³</p><p style="margin: 0;">ä»˜æ¬¾ç´€éŒ„ã€Œé£›åˆ°å¤–å¤ªç©ºã€ä¸è¦‹äº†çš„æƒ…æ³</p><p style="margin: 0;">è«‹å‹™å¿…ç¢ºèªæ¢ç¢¼å…§å®¹æ­£ç¢ºç„¡èª¤</p><p style="margin-top: 0.0em;">âš ï¸é¢¨éšªéœ€ç”±æ‚¨è‡ªè¡Œæ‰¿æ“”!è«‹å°å¿ƒä½¿ç”¨</p></div><div style="font-size:0.95em;color:#555;margin-bottom:16px;">è¨»è§£1. LINEå…§å»ºç€è¦½å™¨ï¼Œæœƒå°è‡´éƒ¨åˆ†åŠŸèƒ½ç„¡æ³•æ“ä½œã€‚<br>è¨»è§£2. å‰4ç¢¼ã€Œå¹´+æœˆã€æœ‰åœ‹æ³°ã€å¯Œé‚¦ã€è¯é‚¦<br>è¨»è§£3. å‰4ç¢¼ã€Œæœˆ+æ—¥ã€æœ‰ç‰å±±ã€å°æ–°ã€å°éŠ€</div><h2>æ¢ç¢¼ç”¢ç”Ÿå™¨</h2><form id="barcodeForm"><label>ç¬¬ä¸‰æ®µæ¢ç¢¼å‰4ç¢¼</label><select id="barcodeType"><option value="YYMM">å¹´+æœˆ</option><option value="MMDD">æœˆ+æ—¥</option></select><select id="bankSelect"><option value="">è«‹é¸æ“‡éŠ€è¡Œ</option><option value="other">å…¶ä»–ï¼ˆè«‹è‡ªè¡Œè¼¸å…¥ï¼‰</option></select><label id="bankLabel" style="display:none;">è«‹è¼¸å…¥éŠ€è¡Œåç¨±</label><input type="text" id="bankInput" placeholder="è«‹è¼¸å…¥éŠ€è¡Œåç¨±" style="display:none;" /><label>ç¬¬ä¸€æ®µæ¢ç¢¼ (9ç¢¼)</label><input type="text" id="firstBarcode" maxlength="9" pattern="[A-Za-z0-9]{9}" title="è«‹è¼¸å…¥ 9 ä½è‹±æ–‡æˆ–æ•¸å­—" required class="uppercase-input" /><span id="bankName" style="color:blue;font-weight:bold;"></span><label>ç¬¬äºŒæ®µæ¢ç¢¼ (16ç¢¼) <span style="margin-left:8px;color: blue;">(éŠ·å¸³ç·¨è™Ÿ)</span></label><input type="text" id="secondBarcode" maxlength="16" pattern="[A-Za-z0-9]{16}" title="è«‹è¼¸å…¥ 16 ä½è‹±æ–‡æˆ–æ•¸å­—" required class="uppercase-input" placeholder="è«‹è¬¹æ…ç¢ºèª" /><label>ç¹³è²»æœŸé™ (YYYMMDD)</label><input type="text" id="paymentDue" maxlength="7" pattern="^[0-9]{7}$" title="è«‹è¼¸å…¥æ­£ç¢ºæ ¼å¼ï¼ˆYYYMMDDï¼‰" required /><label>ç¹³è²»é‡‘é¡</label><input type="text" id="paymentAmount" pattern="^[0-9]+$" title="è«‹è¼¸å…¥æ•¸å­—é‡‘é¡" required /><label>é‡‘é¡éå¢</label><select id="amountIncrementType"><option value="0">ç„¡ (é‡‘é¡å›ºå®š)</option><option value="1">é€£çºŒ +1 å…ƒ</option><option value="5">é€£çºŒ +5 å…ƒ</option><option value="10">é€£çºŒ +10 å…ƒ</option><option value="custom">è‡ªè¨‚</option></select><input type="number" id="customIncrementAmount" placeholder="è«‹è¼¸å…¥è‡ªè¨‚éå¢é‡‘é¡" style="display:none;" /><label>æ¢ç¢¼æ•¸é‡ (å‰©é¤˜ <span id="quotaDisplay">0</span> å¼µ)</label><select id="qrCount"></select><button type="submit" id="generateBtn">æ¢ç¢¼ç”¢ç”Ÿå™¨</button></form></div>
  <div id="previewPage"><div class="preview-actions"><div class="download-button-container"><button id="downloadAllBtn">å…¨éƒ¨ä¸‹è¼‰æ¢ç¢¼</button></div><button id="backToGeneratorBtn">è¿”å›ç”¢ç”Ÿå™¨</button></div><div class="preview-container" id="previewContainer"></div></div>
  <div id="adminPanel"><h3>è¨»å†Šç¢¼ç®¡ç†</h3><table id="serialTable"><thead><tr><th>åºè™Ÿ</th><th>ç¸½æ¬¡æ•¸</th><th>å·²ç”¨æ¬¡æ•¸</th><th>æ“ä½œ</th></tr></thead><tbody id="serialTableBody"></tbody></table><div class="admin-button-group"><button id="addRowBtn">æ–°å¢ä¸€åˆ—</button><button id="saveSerialsBtn">å„²å­˜è®Šæ›´</button><button id="cancelAdminBtn" style="background-color: #6c757d;">è¿”å›ä¸»ç•«é¢</button></div><div id="adminMsg" style="color: red; margin-top: 1rem; text-align: center;"></div></div>
  <div id="userAdminPanel"><h3>ä½¿ç”¨è€…ç®¡ç†</h3><table id="userTable"><thead><tr><th>å¸³è™Ÿ</th><th>QRæ¬Šé™</th><th>ç›®å‰å¯ç”¨æ¬¡æ•¸</th><th>æ¯æœˆé‡è¨­é¡åº¦</th><th>è¨»å†Šæ—¥æœŸ</th></tr></thead><tbody id="userTableBody"></tbody></table><div class="admin-button-group"><button id="saveUsersBtn">å„²å­˜è®Šæ›´</button><button id="cancelUserAdminBtn" style="background-color: #6c757d;">è¿”å›ä¸»ç•«é¢</button></div><div id="userAdminMsg" style="color: red; margin-top: 1rem; text-align: center;"></div></div>
  <div id="customAlert"><div id="customAlertBox"><div id="customAlertMsg"></div><div id="customAlertButtons"></div></div></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
    // â–¼â–¼â–¼ ç¬¬ä¸€éƒ¨åˆ†ï¼šæ‰€æœ‰å‡½å¼å®šç¾© â–¼â–¼â–¼

    // â–¼ å…¨åŸŸè®Šæ•¸ â–¼
    let currentUserProfile = null;
    let accountToVerify = '';
    let generatedBarcodeData = [];
    let currentBatchRequestKey = null;

    /** @typedef {Error & {json?: object}} ApiError */
    function callApi(endpoint, action, data = {}) {
      const authToken = localStorage.getItem('authToken');
      const headers = {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${authToken}`,
      };

      const options = {
        method: action ? 'POST' : 'GET',
        headers,
      };

      if (action) {
        options.body = JSON.stringify({ action, ...data });
      }

      return fetch(`/api/${endpoint}`, options)
        .then(response => {
          if (!response.ok) {
            return response.json().then(err => {
              throw new Error(err.error || `ä¼ºæœå™¨å›å‚³ ${response.status}`);
            });
          }
          return response.json();
        })
        .catch(error => {
          console.error(`API è«‹æ±‚å¤±æ•—: ${endpoint} (${action || 'GET'})`, error);
          throw error;
        });
    }

    function handleResponse(response) {
    return response.json().then(json => {
    if (!response.ok) {
    const error = /** @type {ApiError} */ (new Error(json.message || `ä¼ºæœå™¨å›å‚³ ${response.status}`));
    error.json = json;
    if (response.status === 401 || response.status === 403) {
    if(document.getElementById('loginBox').style.display !== 'flex') {
    localStorage.removeItem('authToken');
    showCustomAlert('æ‚¨çš„ç™»å…¥ç‹€æ…‹å·²éæœŸæˆ–ç„¡æ•ˆï¼Œè«‹é‡æ–°ç™»å…¥ã€‚');
    setTimeout(showLogin, 1500);
    }
    }
    throw error;
    }
    return json;
    });
    }

    // â–¼ UI é¡¯ç¤º/éš±è—æ§åˆ¶å‡½å¼ â–¼
    function showLogin() {
    document.getElementById('profileBox').style.display = 'none';
    document.getElementById('registerBox').style.display = 'none';
    document.getElementById('forgotBox').style.display = 'none';
    document.getElementById('verifyBox').style.display = 'none';
    document.getElementById('legacyVerifyBox').style.display = 'none';
    document.getElementById('mainApp').style.display = 'none';
    document.getElementById('previewPage').style.display = 'none';
    document.getElementById('adminPanel').style.display = 'none';
    document.getElementById('userAdminPanel').style.display = 'none';
    document.getElementById('loginBox').style.display = 'flex';
    document.getElementById('loginMsg').innerText = '';
    }

    function showRegister() {
    document.getElementById('loginBox').style.display = 'none';
    document.getElementById('registerBox').style.display = 'flex';
    }

    function showForgotBox() {
    document.getElementById('loginBox').style.display = 'none';
    document.getElementById('forgotBox').style.display = 'flex';
    document.getElementById('forgotMsg').innerText = '';
    }

    function hideForgotBox() {
    showLogin();
    }

    function showMainAppPage() {
    showLogin();
    document.getElementById('loginBox').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    }

    function showPreviewPage() {
    showLogin();
    document.getElementById('loginBox').style.display = 'none';
    document.getElementById('previewPage').style.display = 'block';
    }

    // â–¼ å½ˆå‡ºå¼æç¤ºæ¡† â–¼
    function showCustomAlert(msg) {
    document.getElementById('customAlertButtons').innerHTML = '<button onclick="closeCustomAlert()">ç¢ºå®š</button>';
    document.getElementById('customAlertMsg').innerHTML = String(msg).replace(/\n/g, '<br>');
    document.getElementById('customAlert').style.display = 'flex';
    }

    function closeCustomAlert() {
    document.getElementById('customAlert').style.display = 'none';
    }

    // â–¼ æ ¸å¿ƒåŠŸèƒ½å‡½å¼ â–¼
    function register() {
    const account = document.getElementById('registerAccount').value.trim();
    const password = document.getElementById('registerPassword').value.trim();
    const email = document.getElementById('registerEmail').value.trim();
    const serial = document.getElementById('registerSerial').value.trim();
    const msgDiv = document.getElementById('registerMsg');
    msgDiv.innerText = '';
    if (!account || !password || !email || !serial) { msgDiv.innerText = 'æ‰€æœ‰æ¬„ä½çš†ç‚ºå¿…å¡«'; return; }
    if (!validatePassword(password)) { msgDiv.innerText = 'å¯†ç¢¼æ ¼å¼ä¸ç¬¦ï¼Œè«‹ç¢ºèªæ ¼å¼'; return; }
    msgDiv.innerText = 'è¨»å†Šä¸­...';

    callApi('auth', 'register', { username: account, password, email, serial })
    .then(res => {
    if (res.result === 'success_pending_verification') {
    msgDiv.innerText = '';
    accountToVerify = account;
    document.getElementById('registerBox').style.display = 'none';
    document.getElementById('verifyBox').style.display = 'flex';
    document.getElementById('verifyInfoMsg').innerHTML = `æˆ‘å€‘å·²å°‡ä¸€çµ„ 6 ä½æ•¸é©—è­‰ç¢¼å¯„é€åˆ° <strong style=\"color: #007bff;\">${email}</strong>ï¼Œ<br>è«‹åœ¨ 10 åˆ†é˜å…§è¼¸å…¥ä»¥å®Œæˆé©—è­‰ã€‚`;
    }
    })
    .catch(err => { msgDiv.innerText = err.message; });
    }

    function login() {
    const account = document.getElementById('loginAccount').value.trim();
    const password = document.getElementById('loginPassword').value.trim();
    if (!account || !password) { document.getElementById('loginMsg').innerText = 'å¸³è™Ÿå’Œå¯†ç¢¼ä¸èƒ½ç‚ºç©º'; return; }
    document.getElementById('loginMsg').innerText = 'ç™»å…¥ä¸­...';

    callApi('auth', 'login', { account, password })
    .then(res => {
    if (res.success && res.token) {
    localStorage.setItem('authToken', res.token);
    currentUserProfile = res.profile;
    updateQuotaDisplay();
    setQrCountOptions();
    updateButtonLabels();
    if (currentUserProfile.isAdmin) {
    document.getElementById('adminBtn').style.display = 'inline-block';
    document.getElementById('userAdminBtn').style.display = 'inline-block';
    } else {
    document.getElementById('adminBtn').style.display = 'none';
    document.getElementById('userAdminBtn').style.display = 'none';
    }
    showMainAppPage();
    }
    })
    .catch(err => {
    if (err.json && err.json.reason === 'unverified') {
    accountToVerify = account;
    document.getElementById('loginBox').style.display = 'none';
    document.getElementById('verifyBox').style.display = 'flex';
    document.getElementById('verifyInfoMsg').innerHTML = `æ­¤å¸³è™Ÿ <strong style="color: #007bff;">${account}</strong> å°šæœªå®Œæˆä¿¡ç®±é©—è­‰ã€‚<br>è«‹æª¢æŸ¥æ‚¨çš„ä¿¡ç®±ä»¥ç²å–é©—è­‰ç¢¼ã€‚`;
    document.getElementById('loginMsg').innerText = '';
    } else {
    document.getElementById('loginMsg').innerText = 'ç™»å…¥å¤±æ•—ï¼š' + err.message;
    }
    });
    }

    function logout() {
    localStorage.removeItem('authToken');
    currentUserProfile = null;
    showLogin();
    }

    function loadBankSelect() {
    fetch('/api/getBanks')
    .then(response => {
    if (!response.ok) {
    return response.json().then(err => { throw new Error(err.error || 'ç„¡æ³•å¾ä¼ºæœå™¨ç²å–éŠ€è¡Œåˆ—è¡¨ã€‚') });
    }
    return response.json();
    })
    .then(banks => {
    const select = document.getElementById('bankSelect');
    const otherOption = select.querySelector('option[value="other"]');
    while (select.options.length > 2) { select.remove(1); }
    if (banks && banks.length > 0) {
    banks.forEach(function(name) {
    const opt = document.createElement('option');
    opt.value = name;
    opt.textContent = name;
    select.insertBefore(opt, otherOption);
    });
    }
    })
    .catch(error => {
    console.error("è¼‰å…¥éŠ€è¡Œåˆ—è¡¨å¤±æ•—:", error);
    showCustomAlert("ç„¡æ³•è¼‰å…¥éŠ€è¡Œåˆ—è¡¨ï¼Œè«‹ç¢ºèªå¾Œç«¯è¨­å®šæ˜¯å¦æ­£ç¢ºã€‚");
    });
    }

    function handleGenerateClick() {
    if (!validateInputs()) return;
    showCustomAlert("æ­£åœ¨å¾Œç«¯è¨ˆç®—æ¢ç¢¼ï¼Œè«‹ç¨å€™...");
    const incrementType = document.getElementById('amountIncrementType').value;
    const incrementAmount = (incrementType === 'custom') ? (parseInt(document.getElementById('customIncrementAmount').value, 10) || 0) : parseInt(incrementType, 10);
    const params = {
    firstBarcode: document.getElementById("firstBarcode").value.trim().toUpperCase(),
    secondBarcode: document.getElementById("secondBarcode").value.trim().toUpperCase(),
    paymentDue: document.getElementById("paymentDue").value.trim(),
    paymentAmount: document.getElementById("paymentAmount").value.trim(),
    qrCount: parseInt(document.getElementById("qrCount").value, 10) || 1,
    barcodeType: document.getElementById("barcodeType").value,
    incrementAmount: incrementAmount,
    requestKey: generateRequestKey()
    };
    callApi('generateBarcodes', null, params)
    .then(backendResult => {
    closeCustomAlert();
    generatedBarcodeData = backendResult.barcodes;
    currentBatchRequestKey = backendResult.requestKey;
    generatePreviewUI();
    showPreviewPage();
    })
    .catch(error => {
    closeCustomAlert();
    showCustomAlert("è™•ç†å¤±æ•—ï¼š<br>" + error.message);
    });
    }

    function generatePreviewUI() {
    const container = document.getElementById("previewContainer");
    container.innerHTML = "";
    const downloadBtn = document.getElementById('downloadAllBtn');
    downloadBtn.style.display = 'none';
    if (!generatedBarcodeData || generatedBarcodeData.length === 0) return;
    const displayLimit = 10;
    generatedBarcodeData.slice(0, displayLimit).forEach(data => {
    const wrapper = createBarcodeWrapper(data, false, false);
    container.appendChild(wrapper);
    wrapper.querySelectorAll("canvas.barcode-canvas").forEach(canvas => {
    const barcodeValue = canvas.getAttribute('data-barcode');
    JsBarcode(canvas, barcodeValue, { format: "CODE128", displayValue: false, height: 50, width: 1.5, margin: 0, background: "transparent" });
    });
    });
    if (generatedBarcodeData.length > 0) {
    downloadBtn.textContent = `å…¨éƒ¨ä¸‹è¼‰æ¢ç¢¼ (${generatedBarcodeData.length})`;
    downloadBtn.style.display = 'inline-block';
    }
    }

    function createBarcodeWrapper(data, includeTitle, includeReminder) {
    const wrapper = document.createElement("div");
    wrapper.className = "qr-wrapper";
    const serialNumber = document.createElement("div");
    serialNumber.className = "serial-number";
    serialNumber.textContent = data.serial;
    wrapper.appendChild(serialNumber);
    if (includeTitle) {
    const title = document.createElement("div");
    title.className = "barcode-title";
    title.textContent = "è¶…å•†ç¹³è²»æ¢ç¢¼";
    wrapper.appendChild(title);
    }
    data.barcodes.forEach((code, idx) => {
    const barcodeContainer = document.createElement("div");
    const marginBottomValue = (idx < 2) ? (includeTitle ? "40px" : "36px") : "0";
    let style = `margin-bottom: ${marginBottomValue}; text-align:center; overflow-x:auto; width:100%;`;
    if (!includeTitle && idx === 0) style += `padding-top: 10px;`;
    barcodeContainer.style.cssText = style;
    const canvas = document.createElement("canvas");
    canvas.className = "barcode-canvas";
    canvas.setAttribute('data-barcode', code);
    barcodeContainer.appendChild(canvas);
    const textDiv = document.createElement("div");
    textDiv.textContent = code;
    textDiv.style.cssText = "font-family: monospace; font-size: 22px; letter-spacing: 1px; margin-top: 4px;";
    barcodeContainer.appendChild(textDiv);
    wrapper.appendChild(barcodeContainer);
    });
    if (includeReminder) {
    const reminder = document.createElement("div");
    reminder.className = "barcode-reminder";
    reminder.textContent = "æé†’æ‚¨ï¼Œè¶…å•†ç¹³æ¬¾ä¸Šé™ç‚º2è¬å…ƒã€‚";
    wrapper.appendChild(reminder);
    }
    return wrapper;
    }

    function startDownloadProcess() {
    const qrCount = generatedBarcodeData.length;
    if (qrCount === 0) { return showCustomAlert("æ²’æœ‰å¯ä¸‹è¼‰çš„é …ç›®ã€‚"); }
    const msg = `<div class="download-alert-title">ä¸‹è¼‰å°‡æœƒæ‰£é™¤é¡åº¦</div><div class="download-alert-desc">ç¢ºå®šè¦ä¸‹è¼‰å…¨éƒ¨ <b>${qrCount}</b> å¼µåœ–æª”å—ï¼Ÿ</div><div class="download-alert-list-title">ä¸‹è¼‰åœ–ç‰‡å«ä¸‹åˆ—æ–‡å­—ï¼š</div><div class="download-alert-checkboxes"><label class="checkbox-label-align"><input type="checkbox" id="includeTitleForDownload" checked> è¶…å•†ç¹³è²»æ¢ç¢¼</label><label class="checkbox-label-align"><input type="checkbox" id="includeReminderForDownload" checked> æé†’æ‚¨ï¼Œè¶…å•†ç¹³æ¬¾ä¸Šé™ç‚º2è¬å…ƒã€‚</label></div>`;
    const buttons = `<button id="cancelBtn" onclick="closeCustomAlert()">å–æ¶ˆ</button><button id="confirmBtn">ç¢ºå®š</button>`;
    document.getElementById('customAlertMsg').innerHTML = msg;
    document.getElementById('customAlertButtons').innerHTML = buttons;
    document.getElementById('customAlert').style.display = 'flex';
    document.getElementById('confirmBtn').onclick = function() {
    const includeTitle = document.getElementById('includeTitleForDownload').checked;
    const includeReminder = document.getElementById('includeReminderForDownload').checked;
    closeCustomAlert();
    showCustomAlert("æ­£åœ¨èˆ‡ä¼ºæœå™¨ç¢ºèªé¡åº¦...");
    callApi('deductQuota', null, { countToDeduct: qrCount, requestKey: currentBatchRequestKey })
    .then(res => {
    if (res.success) {
    currentUserProfile.current_quota = res.newQuota;
    executeDownload(includeTitle, includeReminder);
    }
    })
    .catch(err => { showCustomAlert('æ“ä½œå¤±æ•—ï¼š<br>' + err.message); });
    };
    }

    function executeDownload(includeTitle, includeReminder) {
    showCustomAlert("æº–å‚™ä¸‹è¼‰ä¸­ï¼Œè«‹ç¨å€™...");
    const zip = new JSZip();
    const tempContainer = document.createElement("div");
    tempContainer.style.cssText = "position: fixed; left: -9999px; top: 0; padding: 28px 24px 20px 24px;";
    document.body.appendChild(tempContainer);
    const promises = generatedBarcodeData.map(data => {
    return new Promise((resolve, reject) => {
    const wrapper = createBarcodeWrapper(data, includeTitle, includeReminder);
    tempContainer.appendChild(wrapper);
    setTimeout(() => {
    try {
    wrapper.querySelectorAll("canvas.barcode-canvas").forEach(canvas => {
    JsBarcode(canvas, canvas.getAttribute('data-barcode'), { format: "CODE128", displayValue: false, height: 50, width: 1.5, margin: 0, background: "transparent" });
    });
    html2canvas(wrapper, { scale: 2 }).then(canvas => {
    const base64 = canvas.toDataURL("image/png").split(',')[1];
    zip.file(`ä¿¡ç”¨å¡å¸³å–®_${data.serial}.png`, base64, { base64: true });
    tempContainer.removeChild(wrapper);
    resolve();
    }).catch(reject);
    } catch (e) { reject(e); }
    }, 50);
    });
    });
    Promise.all(promises).then(() => {
    document.body.removeChild(tempContainer);
    if (Object.keys(zip.files).length > 0) {
    showCustomAlert("æ­£åœ¨å£“ç¸®æª”æ¡ˆ...");
    zip.generateAsync({ type: "blob" }).then(content => {
    saveAs(content, "ä¿¡ç”¨å¡å¸³å–®.zip");
    closeCustomAlert();
    });
    } else { showCustomAlert("æ²’æœ‰å¯ä¸‹è¼‰çš„é …ç›®ã€‚"); }
    }).catch(err => {
    document.body.removeChild(tempContainer);
    showCustomAlert('ç”¢ç”Ÿåœ–ç‰‡å¤±æ•—: ' + err.message);
    });
    }

    function validatePassword(password) { return /^(?=.*[a-z])(?=.*[A-Z])(?=.*[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]).{8,}$/.test(password); }

    function verifyCode() {
    const code = document.getElementById('verifyCode').value.trim();
    const msgDiv = document.getElementById('verifyMsg');
    msgDiv.innerText = '';
    if (!code || code.length !== 6) { msgDiv.innerText = 'è«‹è¼¸å…¥ 6 ä½æ•¸é©—è­‰ç¢¼ã€‚'; return; }
    msgDiv.innerText = 'é©—è­‰ä¸­...';
    callApi('auth', 'verifyCode', { account: accountToVerify, code: code })
    .then(res => {
    if (res.success) {
    msgDiv.innerText = '';
    showCustomAlert('ä¿¡ç®±é©—è­‰æˆåŠŸï¼\nç¾åœ¨æ‚¨å¯ä»¥ç™»å…¥äº†ã€‚');
    showLogin();
    }
    })
    .catch(err => {
    if (err.message.includes('éæœŸ')) {
    msgDiv.innerText = 'é©—è­‰ç¢¼å·²éæœŸï¼Œè«‹é»æ“Šä¸‹æ–¹çš„ã€Œé‡æ–°å¯„é€ã€æŒ‰éˆ•ç²å–æ–°ç¢¼ã€‚';
    } else {
    msgDiv.innerText = err.message;
    }
    });
    }

    function resendCode() {
    const msgDiv = document.getElementById('verifyMsg');
    msgDiv.innerText = 'æ­£åœ¨é‡æ–°å¯„é€...';
    callApi('auth', 'resendCode', { account: accountToVerify })
    .then(res => {
    if (res.success) {
    msgDiv.innerText = '';
    showCustomAlert('æ–°çš„é©—è­‰ç¢¼å·²æˆåŠŸå¯„å‡ºï¼Œè«‹æª¢æŸ¥æ‚¨çš„ä¿¡ç®±ã€‚');
    }
    })
    .catch(err => { msgDiv.innerText = err.message; });
    }

    function updateQuotaDisplay() {
    const quota = (currentUserProfile && typeof currentUserProfile.current_quota !== 'undefined') ? currentUserProfile.current_quota : 0;
    document.getElementById('quotaDisplay').innerText = quota;
    }

    function setQrCountOptions() {
    const select = document.getElementById('qrCount');
    const generateBtn = document.getElementById("generateBtn");
    select.innerHTML = "";
    const quota = (currentUserProfile && typeof currentUserProfile.current_quota !== 'undefined') ? currentUserProfile.current_quota : 0;
    const max = Math.min(40, quota);
    if (max > 0) {
    for (let i = 1; i <= max; i++) {
    const option = document.createElement('option');
    option.value = i;
    option.textContent = i;
    select.appendChild(option);
    }
    select.disabled = false;
    generateBtn.disabled = false;
    } else {
    const option = document.createElement('option');
    option.value = 0;
    option.textContent = "0";
    select.appendChild(option);
    select.disabled = true;
    generateBtn.disabled = true;
    }
    }

    function clearPreviews() {
    document.getElementById('previewContainer').innerHTML = '';
    document.getElementById('downloadAllBtn').style.display = 'none';
    generatedBarcodeData = [];
    }

    function forgotPassword() {
    const email = document.getElementById('forgotEmail').value.trim();
    const msgDiv = document.getElementById('forgotMsg');
    if (!email) { msgDiv.innerText = 'è«‹è¼¸å…¥æ‚¨è¨»å†Šæ™‚ä½¿ç”¨çš„é›»å­ä¿¡ç®±'; return; }
    msgDiv.innerText = 'è™•ç†ä¸­...';
    callApi('auth', 'forgotPassword', { email: email })
    .then(res => {
    msgDiv.innerText = '';
    showCustomAlert(res.message);
    })
    .catch(err => {
    msgDiv.innerText = '';
    showCustomAlert('å¦‚æœæ‚¨çš„ä¿¡ç®±å­˜åœ¨æ–¼æˆ‘å€‘çš„ç³»çµ±ä¸­ï¼Œæ‚¨å°‡æœƒæ”¶åˆ°ä¸€å°æç¤ºéƒµä»¶ã€‚');
    });
    }

    function onFirstBarcodeInput() {}
    function onBankSelectChange() {
    const isOther = document.getElementById('bankSelect').value === 'other';
    document.getElementById('bankInput').style.display = isOther ? 'block' : 'none';
    document.getElementById('bankLabel').style.display = isOther ? 'block' : 'none';
    }

    function showProfile() {
    if (!currentUserProfile) { showCustomAlert("ç„¡æ³•ç²å–æœƒå“¡è³‡æ–™ï¼Œè«‹é‡æ–°ç™»å…¥ã€‚"); return; }
    document.getElementById('profileAccount').textContent = currentUserProfile.account || 'N/A';
    document.getElementById('profileEmail').value = currentUserProfile.email || '';
    document.getElementById('profileQuota').textContent = (typeof currentUserProfile.current_quota !== 'undefined') ? currentUserProfile.current_quota : 'N/A';
    const registerDate = currentUserProfile.register_date ? new Date(currentUserProfile.register_date).toLocaleString('zh-TW') : 'N/A';
    const lastModified = currentUserProfile.last_modified ? new Date(currentUserProfile.last_modified).toLocaleString('zh-TW') : 'ç„¡ä¿®æ”¹ç´€éŒ„';
    document.getElementById('profileRegisterDate').textContent = registerDate;
    document.getElementById('profileLastModified').textContent = lastModified;
    document.getElementById('profilePassword').value = '';
    document.getElementById('currentPassword').value = '';
    document.getElementById('profileMsg').textContent = '';
    showLogin();
    document.getElementById('loginBox').style.display = 'none';
    document.getElementById('profileBox').style.display = 'flex';
    }

    function hideProfile() {
    document.getElementById('profileBox').style.display = 'none';
    showMainAppPage();
    }

    function saveProfile() {
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('profilePassword').value;
    const profileMsg = document.getElementById('profileMsg');
    if (!currentPassword) { profileMsg.textContent = 'ç‚ºäº†å®‰å…¨ï¼Œè«‹å‹™å¿…è¼¸å…¥æ‚¨ç›®å‰çš„å¯†ç¢¼ä»¥å„²å­˜è®Šæ›´ã€‚'; return; }
    if (newPassword && !validatePassword(newPassword)) { profileMsg.textContent = 'æ–°å¯†ç¢¼æ ¼å¼ä¸ç¬¦åˆè¦æ±‚ã€‚'; return; }
    if (!newPassword) { profileMsg.textContent = 'è³‡æ–™æœªè®Šæ›´ã€‚'; setTimeout(hideProfile, 1500); return; }
    profileMsg.textContent = 'å„²å­˜ä¸­...';
    callApi('auth', 'updateProfile', { currentPassword, newPassword: newPassword || null })
    .then(res => {
    if (res.success) {
    profileMsg.textContent = res.message;
    if (newPassword) {
    showCustomAlert("å¯†ç¢¼å·²æˆåŠŸæ›´æ–°ï¼ç‚ºäº†å®‰å…¨ï¼Œç³»çµ±å°‡ç‚ºæ‚¨ç™»å‡ºï¼Œè«‹ä½¿ç”¨æ‚¨çš„æ–°å¯†ç¢¼é‡æ–°ç™»å…¥ã€‚");
    setTimeout(logout, 2000);
    }
    }
    })
    .catch(err => { profileMsg.textContent = 'æ›´æ–°å¤±æ•—ï¼š' + err.message; });
    }

    function showAdminPanel() {
    showLogin();
    document.getElementById('loginBox').style.display = 'none';
    document.getElementById('adminPanel').style.display = 'flex';
    document.getElementById('adminMsg').innerText = '';
    loadSerialCodes();
    }

    function hideAdminPanel() {
    document.getElementById('adminPanel').style.display = 'none';
    showMainAppPage();
    }

    function loadSerialCodes() {
        const tbody = document.getElementById('serialTableBody');
        tbody.innerHTML = '<tr><td colspan="4">è¼‰å…¥ä¸­...</td></tr>';
        const headers = { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` };

        fetch('/api/admin/serials', { method: 'GET', headers: headers })
            .then(response => {
                if (!response.ok) return response.json().then(err => { throw new Error(err.message) });
                return response.json();
            })
            .then(serials => {
                tbody.innerHTML = '';
                if (serials && serials.length > 0) {
                    serials.forEach(serial => addSerialRow(serial.serial_code, serial.total_limit, serial.used_count));
                }
            })
            .catch(err => {
                tbody.innerHTML = `<tr style="color:red;"><td colspan="4">è¼‰å…¥å¤±æ•—: ${err.message}</td></tr>`;
            });
    }

    function saveSerialCodes() {
        const msgDiv = document.getElementById('adminMsg');
        msgDiv.innerText = 'å„²å­˜ä¸­...';
        const tableRows = document.querySelectorAll('#serialTableBody tr');
        const serialsData = Array.from(tableRows).map(row => {
            const serialCode = row.querySelector('.serial-input').value.trim();
            const totalLimit = parseInt(row.querySelector('.total-input').value, 10);
            const usedCount = parseInt(row.querySelector('.used-input').value, 10);
            if (serialCode && !isNaN(totalLimit)) {
                return { serial_code: serialCode, total_limit: totalLimit, used_count: usedCount || 0 };
            }
            return null;
        }).filter(Boolean);

        const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('authToken')}` };

        fetch('/api/admin/serials', {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(serialsData)
        })
            .then(response => {
                return response.json().then(json => {
                    if (!response.ok) throw new Error(json.message || `ä¼ºæœå™¨å›å‚³ ${response.status}`);
                    return json;
                });
            })
            .then(res => {
                if (res.success) {
                    msgDiv.innerText = res.message;
                    setTimeout(() => { msgDiv.innerText = ''; loadSerialCodes(); }, 2000);
                }
            })
            .catch(err => {
                msgDiv.innerText = 'å„²å­˜å¤±æ•—: ' + err.message;
            });
    }

    function addSerialRow(serial = '', total = '', used = '') {
    const tbody = document.getElementById('serialTableBody');
    const newRow = tbody.insertRow();
    newRow.innerHTML = `<td><input type="text" class="serial-input" value="${serial}"></td><td><input type="number" class="total-input" value="${total}"></td><td><input type="number" class="used-input" value="${used}" disabled></td><td><button class="delete-row-btn">åˆªé™¤</button></td>`;
    }

    function deleteSerialRow(btn) {
    btn.closest('tr').remove();
    }

    function showUserAdminPanel() {
    showLogin();
    document.getElementById('loginBox').style.display = 'none';
    document.getElementById('userAdminPanel').style.display = 'flex';
    document.getElementById('userAdminMsg').innerText = '';
    loadUsersForAdmin();
    }

// index.html ä¸­çš„ hideUserAdminPanel (æœ€çµ‚ä¿®æ­£ç‰ˆ)
function hideUserAdminPanel() {
    document.getElementById('userAdminPanel').style.display = 'none';
    showCustomAlert('æ­£åœ¨æ›´æ–°æ‚¨çš„æœ€æ–°è³‡è¨Š...');

    const headers = {};
    const token = localStorage.getItem('authToken');
    if (token) {
        headers['Authorization'] = `Bearer ${token}`;
    }

    // â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®æ­£ã€‘å°‡è·¯å¾‘æŒ‡å‘ç¨ç«‹çš„ /api/getProfile æª”æ¡ˆ â–¼â–¼â–¼
    fetch('/api/getProfile', {
        method: 'GET', // ç¢ºä¿ä½¿ç”¨ GET æ–¹æ³•
        headers: headers
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(errBody => { throw new Error(errBody.message || `ä¼ºæœå™¨å›å‚³ ${response.status}`) });
        }
        return response.json();
    })
    .then(latestProfile => {
        closeCustomAlert();
        // ç”¨æœ€æ–°çš„è³‡æ–™ã€è¦†è“‹ã€‘æ‰èˆŠçš„å…¨åŸŸè®Šæ•¸
        currentUserProfile = latestProfile;
        
        // ã€é‡è¦ã€‘ç”¨æœ€æ–°çš„è³‡æ–™ï¼Œæ‰‹å‹•æ›´æ–°ä¸€æ¬¡ä¸»é é¢çš„æ‰€æœ‰ç›¸é—œ UI
        updateQuotaDisplay();
        setQrCountOptions();
        updateButtonLabels();
        
        // æœ€å¾Œæ‰é¡¯ç¤ºä¸»é é¢
        showMainAppPage();
    })
    .catch(err => {
        console.error("é‡æ–°ç²å–å€‹äººè³‡æ–™å¤±æ•—:", err);
        closeCustomAlert();
        showCustomAlert("ç„¡æ³•åŒæ­¥æœ€æ–°è³‡æ–™ï¼Œé¡¯ç¤ºçš„å¯èƒ½ç‚ºèˆŠé¡åº¦ã€‚");
        showMainAppPage();
    });
}

        // index.html ä¸­çš„ loadUsersForAdmin (æœ€çµ‚å®Œæ•´ç‰ˆ)

        // index.html ä¸­çš„ loadUsersForAdmin (æœ€çµ‚å®Œæ•´ç‰ˆ)

    function loadUsersForAdmin() {
        // æ­¥é©Ÿ 1: ç²å–è¡¨æ ¼ä¸»é«” (tbody)ï¼Œä¸¦é¡¯ç¤ºã€Œè¼‰å…¥ä¸­...ã€çš„æç¤º
        const tbody = document.getElementById('userTableBody');
        tbody.innerHTML = '<tr><td colspan="5">è¼‰å…¥ä¸­...</td></tr>';

        // æ­¥é©Ÿ 2: æº–å‚™è«‹æ±‚æ‰€éœ€çš„æ¨™é ­ (Headers)ï¼Œä¸»è¦æ˜¯é™„ä¸Š JWT Token ä»¥é€²è¡Œç®¡ç†å“¡èº«ä»½é©—è­‰
        const headers = {
            'Content-Type': 'application/json'
        };
        const token = localStorage.getItem('authToken');
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }

        // æ­¥é©Ÿ 3: ä½¿ç”¨ fetch å‡½å¼ï¼Œå‘å¾Œç«¯ /api/admin/getUsers ç™¼é€ä¸€å€‹ GET è«‹æ±‚
        fetch('/api/admin/users', {
            method: 'GET',
            headers: headers
        })
        .then(response => {
            // æ­¥é©Ÿ 4: è™•ç†ä¼ºæœå™¨çš„å›æ‡‰
            return response.json().then(json => {
                // æª¢æŸ¥ HTTP ç‹€æ…‹ç¢¼æ˜¯å¦ç‚ºæˆåŠŸ
                if (!response.ok) {
                    // å¦‚æœä¸æˆåŠŸï¼Œå°±æ‹‹å‡ºä¸€å€‹å¸¶æœ‰å¾Œç«¯è¨Šæ¯çš„éŒ¯èª¤
                    throw new Error(json.message || `ä¼ºæœå™¨å›å‚³ ${response.status}`);
                }
                // å¦‚æœæˆåŠŸï¼Œå›å‚³è§£æå¾Œçš„ JSON è³‡æ–™ (ä¹Ÿå°±æ˜¯ä½¿ç”¨è€…é™£åˆ—)
                return json;
            });
        })
        .then(users => {
            // æ­¥é©Ÿ 5: æˆåŠŸç²å–åˆ°ä½¿ç”¨è€…è³‡æ–™é™£åˆ—ï¼Œé–‹å§‹å°‡è³‡æ–™æ¸²æŸ“åˆ°è¡¨æ ¼ä¸­
            tbody.innerHTML = ''; // æ¸…ç©ºã€Œè¼‰å…¥ä¸­...ã€çš„æç¤º
            if (users && users.length > 0) {
                users.forEach(user => {
                    const newRow = tbody.insertRow();
                    // åœ¨æ¯ä¸€è¡Œ (tr) ä¸Šï¼Œä½¿ç”¨ dataset å„²å­˜è©²ä½¿ç”¨è€…çš„å”¯ä¸€ IDï¼Œæ–¹ä¾¿å¾ŒçºŒæ›´æ–°æ“ä½œ
                    newRow.dataset.userId = user.id;

                    // æ ¼å¼åŒ–æ—¥æœŸé¡¯ç¤ºï¼Œä½¿å…¶æ›´ç¬¦åˆå°ç£ç¿’æ…£
                    const registerDate = user.register_date ? new Date(user.register_date).toLocaleDateString('zh-TW') : 'N/A';

                    // ä½¿ç”¨ innerHTML å°‡æ•´è¡Œå„²å­˜æ ¼çš„å…§å®¹ä¸€æ¬¡æ€§å¯«å…¥ï¼Œæ•ˆèƒ½è¼ƒå¥½
                    newRow.innerHTML = `
                        <td>${user.account}</td>
                        <td><input type="checkbox" ${user.permission ? 'checked' : ''}></td>
                        <td><input type="number" value="${user.current_quota}"></td>
                        <td><input type="number" value="${user.reset_quota}"></td>
                        <td>${registerDate}</td>
                    `;
                });
            } else {
                // å¦‚æœæ²’æœ‰ä»»ä½•ä½¿ç”¨è€…è³‡æ–™ï¼Œé¡¯ç¤ºæç¤ºè¨Šæ¯
                tbody.innerHTML = '<tr><td colspan="5">æ²’æœ‰ä½¿ç”¨è€…è³‡æ–™ã€‚</td></tr>';
            }
        })
        .catch(err => {
            // æ­¥é©Ÿ 6: å¦‚æœåœ¨ fetch æˆ–å¾ŒçºŒè™•ç†ä¸­ç™¼ç”Ÿä»»ä½•éŒ¯èª¤ï¼Œå°±åœ¨é€™è£¡æ•æ‰
            // å°‡éŒ¯èª¤è¨Šæ¯é¡¯ç¤ºåœ¨è¡¨æ ¼ä¸­ï¼Œæ–¹ä¾¿é™¤éŒ¯
            tbody.innerHTML = `<tr style="color:red;"><td colspan="5">è¼‰å…¥å¤±æ•—: ${err.message}</td></tr>`;
        });
    }

    // index.html ä¸­çš„ saveUsersByAdmin (æœ€çµ‚å®Œæ•´ç‰ˆ)

    function saveUsersByAdmin() {
      const tableBody = document.getElementById('userTableBody');
      const rows = tableBody.querySelectorAll('tr');
      const users = [];

      rows.forEach(row => {
        const id = row.dataset.id;
        const account = row.querySelector('td:nth-child(1)').textContent.trim();
        const permission = row.querySelector('td:nth-child(2) input[type="checkbox"]').checked;
        const currentQuota = parseInt(row.querySelector('td:nth-child(3) input').value, 10) || 0;
        const resetQuota = parseInt(row.querySelector('td:nth-child(4) input').value, 10) || 0;

        if (id) {
          users.push({ id: parseInt(id, 10), account, permission, current_quota: currentQuota, reset_quota: resetQuota });
        }
      });

      console.log('æº–å‚™ç™¼é€çš„ä½¿ç”¨è€…è³‡æ–™:', JSON.stringify(users, null, 2));

      callApi('admin/users', null, users)
        .then(response => {
          console.log('å¾Œç«¯å›æ‡‰æˆåŠŸ:', response);
          document.getElementById('userAdminMsg').innerText = 'å„²å­˜æˆåŠŸ';

          // é‡æ–°åŒæ­¥ä½¿ç”¨è€…è³‡æ–™
          callApi('auth', 'getProfile')
            .then(profile => {
              currentUserProfile = profile;
              updateQuotaDisplay();
              console.log('ä½¿ç”¨è€…è³‡æ–™å·²æ›´æ–°:', profile);
            })
            .catch(err => {
              console.error('é‡æ–°ç²å–å€‹äººè³‡æ–™å¤±æ•—:', err);
              document.getElementById('userAdminMsg').innerText = 'ç„¡æ³•åŒæ­¥æœ€æ–°è³‡æ–™ï¼Œé¡¯ç¤ºçš„å¯èƒ½ç‚ºèˆŠé¡åº¦ã€‚';
            });
        })
        .catch(error => {
          console.error('å„²å­˜å¤±æ•—:', error);
          if (error.json) {
            console.error('å¾Œç«¯å›æ‡‰éŒ¯èª¤å…§å®¹:', error.json);
          }
          document.getElementById('userAdminMsg').innerText = `å„²å­˜å¤±æ•—: ${error.message}`;
        });
    }

    function updateButtonLabels() {
    const countInput = document.getElementById('qrCount');
    if (countInput && countInput.value) {
    const count = parseInt(countInput.value, 10) || 1;
    document.getElementById("generateBtn").textContent = `æ¢ç¢¼ç”¢ç”Ÿå™¨ (${count})`;
    }
    }

    function generateRequestKey() {
    const dataToEncode = [
    document.getElementById('firstBarcode').value.trim(),
    document.getElementById('secondBarcode').value.trim(),
    document.getElementById("paymentDue").value.trim(),
    document.getElementById("paymentAmount").value.trim(),
    document.getElementById('qrCount').value
    ].join('|');
    try {
    return btoa(encodeURIComponent(dataToEncode));
    } catch (e) {
    console.error("btoa encoding failed:", e);
    return `fallback_${new Date().getTime()}`;
    }
    }

    function validateInputs() {
    const first = document.getElementById('firstBarcode').value.trim();
    const second = document.getElementById('secondBarcode').value.trim();
    const paymentDue = document.getElementById("paymentDue").value.trim();
    const amt = document.getElementById("paymentAmount").value.trim();
    if (!first || !second || !paymentDue || !amt) {
    showCustomAlert("æ‰€æœ‰æ¢ç¢¼ç›¸é—œæ¬„ä½çš†ç‚ºå¿…å¡«ï¼");
    return false;
    }
    return true;
    }

    document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('loginBtn').addEventListener('click', login);
    document.getElementById('registerBtn').addEventListener('click', register);
    document.getElementById('barcodeForm').addEventListener('submit', function(event) { event.preventDefault(); handleGenerateClick(); });
    document.getElementById('downloadAllBtn').addEventListener('click', startDownloadProcess);
    document.getElementById('backToGeneratorBtn').addEventListener('click', function() {
    updateQuotaDisplay();
    setQrCountOptions();
    updateButtonLabels();
    showMainAppPage();
    });
    document.getElementById('showRegisterBtn').addEventListener('click', showRegister);
    document.getElementById('registerBackToLoginBtn').addEventListener('click', showLogin);
    document.getElementById('showForgotBtn').addEventListener('click', showForgotBox);
    document.getElementById('forgotBackBtn').addEventListener('click', hideForgotBox);
    document.getElementById('forgotSendBtn').addEventListener('click', forgotPassword);
    document.getElementById('verifyBtn').addEventListener('click', verifyCode);
    document.getElementById('resendCodeBtn').addEventListener('click', resendCode);
    document.getElementById('verifyBackToLoginBtn').addEventListener('click', showLogin);
    document.getElementById('showProfileBtn').addEventListener('click', showProfile);
    document.getElementById('saveProfileBtn').addEventListener('click', saveProfile);
    document.getElementById('logoutBtn').addEventListener('click', logout);
    document.getElementById('cancelProfileBtn').addEventListener('click', hideProfile);
    document.getElementById('adminBtn').addEventListener('click', showAdminPanel);
    document.getElementById('cancelAdminBtn').addEventListener('click', hideAdminPanel);
    document.getElementById('addRowBtn').addEventListener('click', addSerialRow);
    document.getElementById('saveSerialsBtn').addEventListener('click', saveSerialCodes);
    document.getElementById('serialTableBody').addEventListener('click', function(event) { if (event.target.classList.contains('delete-row-btn')) { deleteSerialRow(event.target); } });
    document.getElementById('userAdminBtn').addEventListener('click', showUserAdminPanel);
    document.getElementById('saveUsersBtn').addEventListener('click', saveUsersByAdmin);
    document.getElementById('cancelUserAdminBtn').addEventListener('click', hideUserAdminPanel);
    document.getElementById('bankSelect').addEventListener('change', onBankSelectChange);
    document.getElementById('qrCount').addEventListener('change', updateButtonLabels);
    document.getElementById('amountIncrementType').addEventListener('change', function() {
    document.getElementById('customIncrementAmount').style.display = (this.value === 'custom') ? 'block' : 'none';
    });

    loadBankSelect();
    setQrCountOptions();
    updateButtonLabels();
    });
    </script>

    </body>
    </html>