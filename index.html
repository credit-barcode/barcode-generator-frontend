<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>ç¹³è²»æ¢ç¢¼</title>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; padding: 1rem; font-family: Arial, sans-serif; display: flex; flex-direction: column; align-items: center; background-color: #f4f4f4; }
    h2, h3 { text-align: center; }
    p { font-size: 1rem; font-weight: bold; color: red; text-align: center; margin-bottom: 1rem; }
    form { width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 0.5rem; margin: 0 auto 1rem auto; text-align: center; }
    input, select, button { font-size: 1rem; padding: 0.5rem; width: 100%; border-radius: 6px; border: 1px solid #ccc; }
    button { background-color: #4CAF50; color: white; border: none; cursor: pointer; font-weight: bold; }
    button:hover { background-color: #45a049; }
    button:disabled { background-color: #cccccc; cursor: not-allowed; }
    .preview-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 1rem; width: 100%; max-width: 1200px; margin: 1rem auto; }
    .qr-wrapper { display: flex; flex-direction: column; background-color: #fff; padding: 28px 24px 20px 24px; border: 1px solid #ccc; border-radius: 12px; width: 500px; margin: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: relative; }
    .qr-wrapper .serial-number { position: absolute; top: 18px; right: 24px; background-color: #4CAF50; color: white; font-weight: bold; font-size: 16px; border-radius: 50%; min-width: 32px; height: 32px; display: flex; justify-content: center; align-items: center; padding: 0 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    .qr-wrapper .barcode-title { font-weight: bold; text-align: center; margin-bottom: 24px; font-size: 24px; }
    .qr-wrapper .barcode-reminder { color:orange; font-weight:bold; font-size:16px; text-align:center; margin-top:18px; }
    @media screen and (max-width: 600px) { .qr-wrapper { width: 100%; margin: 10px 0; } }
    #loginBox, #registerBox, #forgotBox, #verifyBox, #legacyVerifyBox { width: 90vw; max-width: 340px; margin: 40px auto; padding: 24px 16px; border: 1px solid #ccc; border-radius: 12px; box-shadow: 0 2px 8px #0001; background: #fff; display: flex; flex-direction: column; align-items: center; }
    #loginBox h3, #registerBox h3, #forgotBox h3, #verifyBox h3, #legacyVerifyBox h3 { margin: 0 0 18px 0; font-size: 1.3rem; text-align: center; font-weight: bold; }
    #loginBox .form-group, #registerBox .form-group, #profileBox .form-group, #verifyBox .form-group, #legacyVerifyBox .form-group { width: 100%; margin-bottom: 16px; text-align: left; position: relative; }
    #loginBox input, #registerBox input, #forgotBox input, #verifyBox input, #legacyVerifyBox input { width: 100%; padding: 12px; font-size: 1.1rem; }
    #loginBox button, #registerBox button, #forgotBox button, #verifyBox button, #legacyVerifyBox button { width: 100%; padding: 12px; font-size: 1.1rem; margin-top: 4px; }
    #loginMsg, #registerMsg, #forgotMsg, #verifyMsg, #legacyVerifyMsg { color: red; margin-top: 12px; text-align: center; font-size: 1rem; min-height: 1.2rem; }
    #mainApp, #previewPage { display: none; width: 100%; max-width: 800px; margin: 0 auto; text-align: center; padding: 1rem; }
    .preview-actions { display: flex; justify-content: center; align-items: center; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
    .download-button-container { text-align: center; margin-top: 0; }
    #downloadAllBtn { width: auto !important; min-width: 150px; display: none; padding: 8px 24px; font-size: 1rem; background-color: #dc3545; margin: 0 auto; }
    #backToGeneratorBtn { width: auto; padding: 8px 24px; font-size: 1rem; background-color: #6c757d; margin-top: 0; }
    #customAlert { display: none; position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; z-index: 9999; background: rgba(0,0,0,0.4); justify-content: center; align-items: center; }
    #customAlertBox { background: #fff; padding: 32px 24px 28px 24px; border-radius: 16px; max-width: 90vw; min-width: 320px; box-shadow: 0 4px 15px rgba(0,0,0,0.18); text-align: center; font-family: inherit; }
    #customAlertMsg { margin-bottom: 18px; font-size: 1.15em; line-height: 1.6; }
    #customAlertButtons { display: flex; justify-content: center; gap: 1.5em; align-items: center; margin-top: 0.5em; }
    #customAlertBox button { padding: 10px 38px; font-size: 1.1em; border-radius: 8px; border: none; font-weight: bold; margin: 0 0.2em; transition: background 0.2s; cursor: pointer; }
    #customAlertBox #confirmBtn { background: #e53935; color: #fff; }
    #customAlertBox #cancelBtn { background: #757d87; color: #fff; }
    #customAlertBox button:not(#confirmBtn):not(#cancelBtn) { background-color: #4CAF50; color: white; }
    .download-alert-title { color: #e53935; font-size: 1.25em; font-weight: bold; margin-bottom: 0.5em; letter-spacing: 1px; }
    .download-alert-desc { color: #222; font-size: 1.08em; margin-bottom: 0.5em; font-weight: 500; }
    .download-alert-list-title { font-size: 1.1em; font-weight: bold; margin: 1em 0 0.5em 0; letter-spacing: 1px; }
    .download-alert-checkboxes { display: flex; flex-direction: column; align-items: flex-start; gap: 0.5em; margin: 0.5em auto 1.2em auto; font-size: 1em; width: fit-content; }
    .download-alert-checkboxes label { display: flex; align-items: center; gap: 0.5em; font-size: 1em; font-weight: 500; cursor: pointer; user-select: none; }
    .download-alert-checkboxes input[type="checkbox"] { width: 18px; height: 18px; accent-color: #e53935; flex-shrink: 0; }
    @media (max-width: 480px) { #customAlertBox { min-width: 90vw; padding: 18px 4vw 18px 4vw; } .download-alert-checkboxes label { font-size: 0.98em; } #customAlertBox button { font-size: 1em; padding: 8px 0; width: 44vw; } }
    #profileBox { display: none; width: 90vw; max-width: 400px; margin: 40px auto; padding: 24px; border: 1px solid #ccc; border-radius: 12px; box-shadow: 0 2px 8px #0001; background: #fff; flex-direction: column; align-items: center; }
    #profileBox h3 { margin: 0 0 24px 0; font-size: 1.3rem; text-align: center; font-weight: bold; }
    #profileBox .form-group label { display: block; font-weight: bold; margin-bottom: 6px; }
    #profileBox .form-group span { background-color: #eee; padding: 8px; display: inline-block; word-break: break-all; border-radius: 4px; width: 100%;}
    #profileBox .button-group { display: flex; gap: 1rem; width: 100%; margin-top: 10px; }
    #profileMsg { color: red; margin-top: 12px; text-align: left; font-size: 0.9rem; width:100%; }
    .input-hint { display: block; width: 100%; text-align: left; font-size: 0.8rem; color: #6c757d; margin-top: 4px; margin-bottom: 0; padding-left: 2px; }
    .uppercase-input { text-transform: uppercase; }
    #adminPanel, #userAdminPanel { display: none; width: 100%; max-width: 1000px; margin: 2rem auto; padding: 1.5rem; background: #fff; border: 1px solid #ccc; border-radius: 12px; flex-direction: column; }
    #adminPanel h3, #userAdminPanel h3 { margin: 0 0 1.5rem 0; }
    #serialTable, #userTable { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
    #serialTable th, #serialTable td, #userTable th, #userTable td { border: 1px solid #ddd; padding: 0.75rem; text-align: center; vertical-align: middle;}
    #serialTable th, #userTable th { background-color: #f2f2f2; }
    #serialTable input, #userTable input[type="number"] { width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; text-align: center; }
    #userTable input[type="checkbox"] { width: 20px; height: 20px; }
    #serialTable .delete-row-btn { background-color: #f44336; color: white; border: none; padding: 6px 10px; cursor: pointer; border-radius: 4px; }
    .admin-button-group { display: flex; flex-direction: column; gap: 0.5rem; width: 100%; margin-top: 1rem; }
  </style>
</head>
<body>

  <div id="loginBox">
    <h3>è«‹å…ˆç™»å…¥</h3>
    <div class="form-group">
      <input id="loginAccount" type="text" placeholder="å¸³è™Ÿ" />
    </div>
    <div class="form-group">
        <input type="password" id="loginPassword" placeholder="å¯†ç¢¼" />
    </div>
    <button id="loginBtn">ç™»å…¥</button>
    <button type="button" id="showRegisterBtn" style="background-color:#6c757d;">è¨»å†Š</button>
    <button type="button" id="showForgotBtn" style="background-color:#ffc107;color:#212529;">å¿˜è¨˜å¯†ç¢¼</button>
    <div id="loginMsg"></div>
  </div>

  <div id="registerBox" style="display:none;">
    <h3>è¨»å†Šæ–°å¸³è™Ÿ</h3>
    <div class="form-group">
      <input id="registerAccount" type="text" placeholder="å¸³è™Ÿ" />
    </div>
    <div class="form-group">
      <input type="password" id="registerPassword" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" />
      <small class="input-hint">å¯†ç¢¼è‡³å°‘8ä½ï¼Œå«å¤§å°å¯«è‹±æ–‡åŠä¸€å€‹ç‰¹æ®Šç¬¦è™Ÿ</small>
    </div>
    <div class="form-group">
      <input id="registerEmail" type="email" placeholder="ä¿¡ç®±" />
    </div>
    <div class="form-group">
      <input id="registerSerial" type="text" placeholder="è¨»å†Šç¢¼" />
    </div>
    <button id="registerBtn">ç¢ºå®šè¨»å†Š</button>
    <button id="registerBackToLoginBtn" style="background-color:#6c757d;">è¿”å›ç™»å…¥</button>
    <div id="registerMsg"></div>
  </div>

  <div id="verifyBox" style="display:none;">
    <h3>è«‹é©—è­‰æ‚¨çš„ä¿¡ç®±</h3>
    <p id="verifyInfoMsg" style="color:#333; font-weight:normal; font-size: 0.9em; line-height: 1.5; margin-bottom: 18px;"></p>
    <div class="form-group">
      <input id="verifyCode" type="text" placeholder="6 ä½æ•¸é©—è­‰ç¢¼" maxlength="6" />
    </div>
    <button id="verifyBtn">é©—è­‰</button>
    <button id="verifyBackToLoginBtn" style="background-color:#6c757d;">è¿”å›ç™»å…¥</button>
    <div id="verifyMsg"></div>
  </div>

  <div id="legacyVerifyBox" style="display:none;">
    <h3>ç³»çµ±æ›´æ–° - è«‹é©—è­‰ä¿¡ç®±</h3>
    <p style="color:#333; font-weight:normal; font-size: 0.9em; line-height: 1.5; margin-bottom: 18px;">ç‚ºæå‡å¸³æˆ¶å®‰å…¨ï¼Œæˆ‘å€‘éœ€è¦æ‚¨å®Œæˆä¿¡ç®±é©—è­‰ã€‚è«‹ç¢ºèªæˆ–ä¿®æ”¹æ‚¨çš„ä¿¡ç®±ï¼Œæˆ‘å€‘å°‡ç™¼é€ä¸€çµ„é©—è­‰ç¢¼çµ¦æ‚¨ã€‚</p>
    <div class="form-group">
      <input id="legacyEmail" type="email" placeholder="è«‹ç¢ºèªæˆ–è¼¸å…¥æ–°ä¿¡ç®±" />
    </div>
    <button id="legacySendBtn">ç™¼é€é©—è­‰ç¢¼</button>
    <button id="legacyLaterBtn" style="background-color:#6c757d;">ç¨å¾Œå†èªª</button>
    <div id="legacyVerifyMsg"></div>
  </div>

  <div id="forgotBox" style="display:none;"><h3>å¿˜è¨˜å¯†ç¢¼</h3><input id="forgotAccount" type="text" placeholder="å¸³è™Ÿ" /><input id="forgotEmail" type="email" placeholder="è¨»å†Šä¿¡ç®±" /><button id="forgotSendBtn">å¯„é€å¯†ç¢¼æç¤º</button><button id="forgotBackBtn" style="background-color:#6c757d;">è¿”å›</button><div id="forgotMsg"></div></div>
  
  <div id="profileBox" style="display:none;">
    <h3>æœƒå“¡è³‡æ–™</h3>
    <div class="form-group"><label>å¸³è™Ÿ</label><span id="profileAccount"></span></div>
    <div class="form-group">
      <label for="profilePassword">æ–°å¯†ç¢¼ (ä¸æ”¹è«‹ç•™ç©º)</label>
      <input type="password" id="profilePassword" placeholder="è«‹è¼¸å…¥æ–°å¯†ç¢¼">
      <small class="input-hint">å¯†ç¢¼è‡³å°‘8ä½ï¼Œå«å¤§å°å¯«è‹±æ–‡åŠä¸€å€‹ç‰¹æ®Šç¬¦è™Ÿ</small>
    </div>
    <div class="form-group"><label for="profileEmail">è¨»å†Šä¿¡ç®±</label><input type="email" id="profileEmail" placeholder="è«‹è¼¸å…¥æ‚¨çš„ä¿¡ç®±"></div>
    <div class="form-group"><label>å‰©é¤˜ä¸‹è¼‰é¡åº¦</label><span id="profileQuota"></span></div>
    <div class="form-group"><label>è¨»å†Šæ—¥æœŸ</label><span id="profileRegisterDate"></span></div>
    <div class="form-group"><label>æœ€å¾Œä¿®æ”¹æ—¥æœŸ</label><span id="profileLastModified"></span></div>
    <div id="profileMsg"></div>
    <div class="button-group"><button id="saveProfileBtn">å„²å­˜è®Šæ›´</button><button id="cancelProfileBtn" style="background-color:#6c757d;">è¿”å›ä¸»ç•«é¢</button></div>
  </div>

  <div id="mainApp">
      <div style="text-align: right; width: 100%; max-width: 800px; margin: 0 auto 1rem auto;">
          <button id="userAdminBtn" style="width: auto; padding: 8px 16px; background-color: #17a2b8; display: none; margin-right: 1rem;">ä½¿ç”¨è€…ç®¡ç†</button>
          <button id="adminBtn" style="width: auto; padding: 8px 16px; background-color: #ff9800; display: none; margin-right: 1rem;">ç®¡ç†è¨»å†Šç¢¼</button>
          <button id="showProfileBtn" style="width: auto; padding: 8px 16px; background-color: #007bff;">æœƒå“¡è³‡æ–™</button>
      </div>
      <div style="text-align: center; line-height: 1.8; border: 2px dashed red; padding: 10px; border-radius: 8px; margin-bottom: 1rem;">
          <p style="margin-bottom: 0.0em;">ğŸš€ <strong>ä½¿ç”¨é¢¨éšªæé†’</strong></p>
          <p style="margin: 0;">ä¿¡ç”¨å¡æ¢ç¢¼ç”¢ç”Ÿå™¨æœ‰å¯èƒ½æœƒç™¼ç”Ÿ</p>
          <p style="margin: 0;">æ¢ç¢¼æƒå¾—éä½†å¯¦éš›æ²’å…¥å¸³</p>
          <p style="margin: 0;">ä»˜æ¬¾ç´€éŒ„ã€Œé£›åˆ°å¤–å¤ªç©ºã€ä¸è¦‹äº†çš„æƒ…æ³</p>
          <p style="margin: 0;">è«‹å‹™å¿…ç¢ºèªæ¢ç¢¼å…§å®¹æ­£ç¢ºç„¡èª¤</p>
          <p style="margin-top: 0.0em;">âš ï¸é¢¨éšªéœ€ç”±æ‚¨è‡ªè¡Œæ‰¿æ“”!è«‹å°å¿ƒä½¿ç”¨</p>
      </div>
      <div style="font-size:0.95em;color:#555;margin-bottom:16px;">
          è¨»è§£1. LINEå…§å»ºç€è¦½å™¨ï¼Œæœƒå°è‡´éƒ¨åˆ†åŠŸèƒ½ç„¡æ³•æ“ä½œã€‚<br>
          è¨»è§£2. å‰4ç¢¼ã€Œå¹´+æœˆã€æœ‰åœ‹æ³°ã€å¯Œé‚¦ã€è¯é‚¦<br>
          è¨»è§£3. å‰4ç¢¼ã€Œæœˆ+æ—¥ã€æœ‰ç‰å±±ã€å°æ–°ã€å°éŠ€
      </div>
      <h2>æ¢ç¢¼ç”¢ç”Ÿå™¨</h2>
            <form id="barcodeForm">
                    <label>ç¬¬ä¸‰æ®µæ¢ç¢¼å‰4ç¢¼</label>
                    <select id="barcodeType">
                        <option value="YYMM">å¹´+æœˆ</option>
                        <option value="MMDD">æœˆ+æ—¥</option>
                    </select>
                    <select id="bankSelect">
                        <option value="">è«‹é¸æ“‡éŠ€è¡Œ</option>
                        <option value="other">å…¶ä»–ï¼ˆè«‹è‡ªè¡Œè¼¸å…¥ï¼‰</option>
                    </select>
                    <label id="bankLabel" style="display:none;">è«‹è¼¸å…¥éŠ€è¡Œåç¨±</label>
                    <input type="text" id="bankInput" placeholder="è«‹è¼¸å…¥éŠ€è¡Œåç¨±" style="display:none;" />
                    <label>ç¬¬ä¸€æ®µæ¢ç¢¼ (9ç¢¼)</label>
                    <input type="text" id="firstBarcode" maxlength="9" pattern="[A-Za-z0-9]{9}" title="è«‹è¼¸å…¥ 9 ä½è‹±æ–‡æˆ–æ•¸å­—" required class="uppercase-input" />
                    <span id="bankName" style="color:blue;font-weight:bold;"></span>
                    <label>ç¬¬äºŒæ®µæ¢ç¢¼ (16ç¢¼) <span style="margin-left:8px;color: blue;">(éŠ·å¸³ç·¨è™Ÿ)</span></label>
                    <input type="text" id="secondBarcode" maxlength="16" pattern="[A-Za-z0-9]{16}" title="è«‹è¼¸å…¥ 16 ä½è‹±æ–‡æˆ–æ•¸å­—" required class="uppercase-input" placeholder="è«‹è¬¹æ…ç¢ºèª" />
                    <label>ç¹³è²»æœŸé™ (YYYMMDD)</label>
                    <input type="text" id="paymentDue" maxlength="7" pattern="^[0-9]{7}$" title="è«‹è¼¸å…¥æ­£ç¢ºæ ¼å¼ï¼ˆYYYMMDDï¼‰" required />
                    
                    <label>ç¹³è²»é‡‘é¡</label>
                    <input type="text" id="paymentAmount" pattern="^[0-9]+$" title="è«‹è¼¸å…¥æ•¸å­—é‡‘é¡" required />
                    
                    <label>é‡‘é¡éå¢</label>
                    <select id="amountIncrementType">
                        <option value="0">ç„¡ (é‡‘é¡å›ºå®š)</option>
                        <option value="1">é€£çºŒ +1 å…ƒ</option>
                        <option value="5">é€£çºŒ +5 å…ƒ</option>
                        <option value="10">é€£çºŒ +10 å…ƒ</option>
                        <option value="custom">è‡ªè¨‚</option>
                    </select>
                    <input type="number" id="customIncrementAmount" placeholder="è«‹è¼¸å…¥è‡ªè¨‚éå¢é‡‘é¡" style="display:none;" />

                    <label>æ¢ç¢¼æ•¸é‡ (å‰©é¤˜ <span id="quotaDisplay">0</span> å¼µ)</label>
                    <select id="qrCount"></select>
                    <button type="submit" id="generateBtn">æ¢ç¢¼ç”¢ç”Ÿå™¨</button>
            </form>
  </div>
  
  <div id="previewPage">
      <h2>ç¹³è²»æ¢ç¢¼</h2>
      <div class="preview-actions">
          <div class="download-button-container">
              <button id="downloadAllBtn">å…¨éƒ¨ä¸‹è¼‰æ¢ç¢¼</button>
          </div>
          <button id="backToGeneratorBtn">è¿”å›ç”¢ç”Ÿå™¨</button>
      </div>
      <div class="preview-container" id="previewContainer"></div>
  </div>

  <div id="adminPanel">
    <h3>è¨»å†Šç¢¼ç®¡ç†</h3>
    <table id="serialTable">
      <thead>
        <tr>
          <th>åºè™Ÿ</th>
          <th>ç¸½æ¬¡æ•¸</th>
          <th>å·²ç”¨æ¬¡æ•¸</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="serialTableBody">
      </tbody>
    </table>
    <div class="admin-button-group">
        <button id="addRowBtn">æ–°å¢ä¸€åˆ—</button>
        <button id="saveSerialsBtn">å„²å­˜è®Šæ›´</button>
        <button id="cancelAdminBtn" style="background-color: #6c757d;">è¿”å›ä¸»ç•«é¢</button>
    </div>
    <div id="adminMsg" style="color: red; margin-top: 1rem; text-align: center;"></div>
  </div>
  
  <div id="userAdminPanel">
    <h3>ä½¿ç”¨è€…ç®¡ç†</h3>
    <table id="userTable">
      <thead>
        <tr>
          <th>å¸³è™Ÿ</th>
          <th>QRæ¬Šé™</th>
          <th>ç›®å‰å¯ç”¨æ¬¡æ•¸</th>
          <th>æ¯æœˆé‡è¨­é¡åº¦</th>
          <th>è¨»å†Šæ—¥æœŸ</th>
        </tr>
      </thead>
      <tbody id="userTableBody">
      </tbody>
    </table>
    <div class="admin-button-group">
        <button id="saveUsersBtn">å„²å­˜è®Šæ›´</button>
        <button id="cancelUserAdminBtn" style="background-color: #6c757d;">è¿”å›ä¸»ç•«é¢</button>
    </div>
    <div id="userAdminMsg" style="color: red; margin-top: 1rem; text-align: center;"></div>
  </div>

  <div id="customAlert"><div id="customAlertBox"><div id="customAlertMsg"></div><div id="customAlertButtons"></div></div></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script>
    // â–¼â–¼â–¼ ã€æ ¸å¿ƒè¨­å®šã€‘è«‹é¸æ“‡ä¸€ç¨®æ–¹å¼è¨­å®šæ‚¨çš„å¾Œç«¯ API URL â–¼â–¼â–¼

    // ã€æ–¹æ¡ˆAï¼šä½¿ç”¨ Vercel Proxy (æ¨è–¦)ã€‘
    const BACKEND_URL = "/api/gas"; 

    // ã€æ–¹æ¡ˆBï¼šç›´æ¥å‘¼å« Google Apps Scriptã€‘
    // const BACKEND_URL = "https://script.google.com/macros/s/æ‚¨çš„GoogleAppsScriptç¶²å€/exec";

    // â–²â–²â–² ã€æ ¸å¿ƒè¨­å®šã€‘ â–²â–²â–²


    // â–¼â–¼â–¼ ç¬¬ä¸€éƒ¨åˆ†ï¼šæ‰€æœ‰å‡½å¼å®šç¾© â–¼â–¼â–¼

    // â–¼ å…¨åŸŸè®Šæ•¸ â–¼
    let userRow = null, userSource = null, isQuotaUnlimited = false;
    let generatedBarcodeData = [], serverDateInfo = null, currentBatchRequestKey = null, currentUserProfile = null;
    let accountToVerify = '';
    let apiToken = null;

    function callBackend(functionName, parameters = []) {
      return fetch(BACKEND_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ functionName, parameters }),
        mode: 'cors'
      })
      .then(response => {
        if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
        return response.json();
      })
      .catch(error => {
        console.error(`Error calling ${functionName}:`, error);
        throw error;
      });
    }
    
    // â–¼ UI é¡¯ç¤º/éš±è—æ§åˆ¶å‡½å¼ â–¼
    function showLogin() {
        document.getElementById('profileBox').style.display = 'none';
        document.getElementById('registerBox').style.display = 'none';
        document.getElementById('forgotBox').style.display = 'none';
        document.getElementById('verifyBox').style.display = 'none';
        document.getElementById('legacyVerifyBox').style.display = 'none';
        document.getElementById('mainApp').style.display = 'none';
        document.getElementById('previewPage').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'none';
        document.getElementById('userAdminPanel').style.display = 'none';
        document.getElementById('loginBox').style.display = 'flex';
        document.getElementById('loginMsg').innerText = '';
    }

    function showRegister() {
        document.getElementById('loginBox').style.display = 'none';
        document.getElementById('registerBox').style.display = 'flex';
    }

    function showForgotBox() {
        document.getElementById('loginBox').style.display = 'none';
        document.getElementById('forgotBox').style.display = 'flex';
        document.getElementById('forgotMsg').innerText = '';
    }
    
    function hideForgotBox() {
        showLogin();
    }
    
    // â–¼ æ ¸å¿ƒUIèˆ‡é‚è¼¯å‡½å¼ â–¼
    function handleGenerateClick() { 
        if (!validateInputs()) return; 
        showCustomAlert("æ­£åœ¨å¾Œç«¯è¨ˆç®—æ¢ç¢¼ï¼Œè«‹ç¨å€™...");
        const incrementType = document.getElementById('amountIncrementType').value;
        const incrementAmount = (incrementType === 'custom') ? (parseInt(document.getElementById('customIncrementAmount').value, 10) || 0) : parseInt(incrementType, 10);
        const params = {
            firstBarcode: document.getElementById("firstBarcode").value.trim().toUpperCase(),
            secondBarcode: document.getElementById("secondBarcode").value.trim().toUpperCase(),
            paymentDue: document.getElementById("paymentDue").value.trim(),
            paymentAmount: document.getElementById("paymentAmount").value.trim(),
            qrCount: parseInt(document.getElementById("qrCount").value, 10),
            barcodeType: document.getElementById("barcodeType").value,
            incrementAmount: incrementAmount,
            token: apiToken
        };
        callBackend('generateBarcodes', [params])
            .then(backendResult => {
                if (backendResult && backendResult.error) { throw new Error(backendResult.message); }
                closeCustomAlert();
                generatedBarcodeData = backendResult;
                generatePreviewUI();
                showPreviewPage();
            })
            .catch(error => {
                closeCustomAlert();
                showCustomAlert("è™•ç†å¤±æ•—ï¼š<br>" + error.message);
            });
    }

    function generatePreviewUI() {
        const container = document.getElementById("previewContainer");
        container.innerHTML = "";
        document.getElementById('downloadAllBtn').style.display = 'none';
        if (!generatedBarcodeData || generatedBarcodeData.length === 0) return;
        const displayLimit = isQuotaUnlimited ? 1 : 10;
        generatedBarcodeData.slice(0, displayLimit).forEach(data => {
            const wrapper = createBarcodeWrapper(data, false, false);
            container.appendChild(wrapper);
            wrapper.querySelectorAll("canvas.barcode-canvas").forEach(canvas => {
                JsBarcode(canvas, canvas.getAttribute('data-barcode'), { format: "CODE128", displayValue: false, height: 50, width: 1.5, margin: 0, background: "transparent" });
            });
        });
        if (!isQuotaUnlimited && generatedBarcodeData.length > 0) {
            const btn = document.getElementById('downloadAllBtn');
            btn.textContent = `å…¨éƒ¨ä¸‹è¼‰æ¢ç¢¼ (${generatedBarcodeData.length})`;
            btn.style.display = 'inline-block';
        }
    }
    
    function showMainAppPage() {
        showLogin(); // Start from a clean slate
        document.getElementById('loginBox').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
    }

    function showPreviewPage() {
        showLogin(); // Start from a clean slate
        document.getElementById('loginBox').style.display = 'none';
        document.getElementById('previewPage').style.display = 'block';
    }

    function createBarcodeWrapper(data, includeTitle, includeReminder) {
        const wrapper = document.createElement("div");
        wrapper.className = "qr-wrapper";
        const serialNumber = document.createElement("div");
        serialNumber.className = "serial-number";
        serialNumber.textContent = data.serial;
        wrapper.appendChild(serialNumber);
        if (includeTitle) {
            const title = document.createElement("div");
            title.className = "barcode-title";
            title.textContent = "è¶…å•†ç¹³è²»æ¢ç¢¼";
            wrapper.appendChild(title);
        }
        data.barcodes.forEach((code, idx) => {
            const barcodeContainer = document.createElement("div");
            const marginBottomValue = (idx < 2) ? (includeTitle ? "40px" : "36px") : "0";
            let style = `margin-bottom: ${marginBottomValue}; text-align:center; overflow-x:auto; width:100%;`;
            if (!includeTitle && idx === 0) style += `padding-top: 10px;`;
            barcodeContainer.style.cssText = style;
            const canvas = document.createElement("canvas");
            canvas.className = "barcode-canvas";
            canvas.setAttribute('data-barcode', code);
            barcodeContainer.appendChild(canvas);
            const textDiv = document.createElement("div");
            textDiv.textContent = code;
            textDiv.style.cssText = "font-family: monospace; font-size: 22px; letter-spacing: 1px; margin-top: 4px;";
            barcodeContainer.appendChild(textDiv);
            wrapper.appendChild(barcodeContainer);
        });
        if (includeReminder) {
            const reminder = document.createElement("div");
            reminder.className = "barcode-reminder";
            reminder.textContent = "æé†’æ‚¨ï¼Œè¶…å•†ç¹³æ¬¾ä¸Šé™ç‚º2è¬å…ƒã€‚";
            wrapper.appendChild(reminder);
        }
        return wrapper;
    }
        
    function startDownloadProcess() {
        if (isQuotaUnlimited) { return showCustomAlert('ç„¡é™é¡åº¦å¸³è™Ÿä¸æä¾›æ‰¹æ¬¡ä¸‹è¼‰åŠŸèƒ½ã€‚'); }
        if (generatedBarcodeData.length === 0) { return showCustomAlert("æ²’æœ‰å¯ä¸‹è¼‰çš„é …ç›®ã€‚"); }
        const msg = `<div class="download-alert-title">ä¸‹è¼‰å°‡æœƒæ‰£é™¤é¡åº¦ã€‚</div><div class="download-alert-desc">ç¢ºå®šè¦ä¸‹è¼‰å…¨éƒ¨ <b>${generatedBarcodeData.length}</b> å¼µåœ–æª”å—ï¼Ÿ</div><div class="download-alert-list-title">ä¸‹è¼‰åœ–ç‰‡å«ä¸‹åˆ—æ–‡å­—ï¼š</div><div class="download-alert-checkboxes"><label class="checkbox-label-align"><input type="checkbox" id="includeTitleForDownload" checked> è¶…å•†ç¹³è²»æ¢ç¢¼</label><label class="checkbox-label-align"><input type="checkbox" id="includeReminderForDownload" checked> æé†’æ‚¨ï¼Œè¶…å•†ç¹³æ¬¾ä¸Šé™ç‚º2è¬å…ƒã€‚</label></div>`;
        const buttons = `<button id="cancelBtn" onclick="closeCustomAlert()">å–æ¶ˆ</button><button id="confirmBtn">ç¢ºå®š</button>`;
        document.getElementById('customAlertMsg').innerHTML = msg;
        document.getElementById('customAlertButtons').innerHTML = buttons;
        document.getElementById('customAlert').style.display = 'flex';
        document.getElementById('confirmBtn').onclick = function() {
            closeCustomAlert();
            const includeTitle = document.getElementById('includeTitleForDownload').checked;
            const includeReminder = document.getElementById('includeReminderForDownload').checked;
            initiateDeductAndDownload(includeTitle, includeReminder);
        };
    }

    function initiateDeductAndDownload(includeTitle, includeReminder) {
        showCustomAlert("æ­£åœ¨é€£ç·š...");
        currentBatchRequestKey = generateRequestKey();
        const params = { userSource, userRow, count: generatedBarcodeData.length, requestKey: currentBatchRequestKey, token: apiToken };
        callBackend('useDownloadQuota', [params])
            .then(response => {
                if (response && response.success) {
                    currentUserProfile.downloadQuota = response.newQuota;
                    updateQuotaDisplay();
                    setQrCountOptions();
                    executeDownload(includeTitle, includeReminder);
                } else { 
                    showCustomAlert(response.msg || "é©—è­‰å¤±æ•—ï¼Œç„¡æ³•ä¸‹è¼‰ã€‚"); 
                }
            })
            .catch(error => { 
                showCustomAlert('é€£ç·šå¤±æ•—ï¼š' + error.message); 
            });
    }

    function executeDownload(includeTitle, includeReminder) {
        showCustomAlert("æº–å‚™ä¸‹è¼‰ä¸­ï¼Œè«‹ç¨å€™...");
        const zip = new JSZip();
        const tempContainer = document.createElement("div");
        tempContainer.style.cssText = "position: fixed; left: -9999px; top: 0; padding: 28px 24px 20px 24px;";
        document.body.appendChild(tempContainer);
        
        const promises = generatedBarcodeData.map(data => {
            return new Promise((resolve, reject) => {
                const wrapper = createBarcodeWrapper(data, includeTitle, includeReminder);
                tempContainer.appendChild(wrapper);
                
                // Use a short timeout to ensure the DOM is updated before canvas rendering
                setTimeout(() => {
                    try {
                        wrapper.querySelectorAll("canvas.barcode-canvas").forEach(canvas => {
                            JsBarcode(canvas, canvas.getAttribute('data-barcode'), { format: "CODE128", displayValue: false, height: 50, width: 1.5, margin: 0, background: "transparent" });
                        });
                        html2canvas(wrapper, { scale: 2 }).then(canvas => {
                            const base64 = canvas.toDataURL("image/png").split(',')[1];
                            zip.file(`ä¿¡ç”¨å¡å¸³å–®_${data.serial}.png`, base64, { base64: true });
                            tempContainer.removeChild(wrapper);
                            resolve();
                        }).catch(reject);
                    } catch (e) {
                        reject(e);
                    }
                }, 50);
            });
        });

        Promise.all(promises).then(() => {
            document.body.removeChild(tempContainer);
            if (Object.keys(zip.files).length > 0) {
                showCustomAlert("æ­£åœ¨å£“ç¸®æª”æ¡ˆ...");
                zip.generateAsync({ type: "blob" }).then(content => {
                    saveAs(content, "ä¿¡ç”¨å¡å¸³å–®.zip");
                    closeCustomAlert();
                });
            } else { 
                showCustomAlert("æ²’æœ‰å¯ä¸‹è¼‰çš„é …ç›®ã€‚"); 
            }
        }).catch(err => {
            document.body.removeChild(tempContainer);
            showCustomAlert('ç”¢ç”Ÿåœ–ç‰‡å¤±æ•—: ' + err.message);
        });
    }
    
    function clearPreviews() { 
        document.getElementById('previewContainer').innerHTML = '';
        document.getElementById('downloadAllBtn').style.display = 'none'; 
        generatedBarcodeData = []; 
        currentBatchRequestKey = null; 
    }
    
    function forgotPassword() { 
        const account = document.getElementById('forgotAccount').value.trim(); 
        const email = document.getElementById('forgotEmail').value.trim(); 
        const msgDiv = document.getElementById('forgotMsg');
        if (!account || !email) { msgDiv.innerText = 'è«‹è¼¸å…¥å¸³è™Ÿèˆ‡ä¿¡ç®±'; return; } 
        msgDiv.innerText = 'æŸ¥è©¢ä¸­...'; 
        callBackend('forgotPassword', [account, email])
            .then(res => { 
                msgDiv.innerText = ''; 
                if (res.result === 'sent') { showCustomAlert('å·²å¯„é€å¯†ç¢¼æç¤ºåˆ°æ‚¨çš„ä¿¡ç®±ã€‚'); } 
                else if (res.result === 'mail_error') { msgDiv.innerText = 'éƒµä»¶ç™¼é€å¤±æ•—ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡ã€‚'; } 
                else { msgDiv.innerText = 'æŸ¥ç„¡æ­¤å¸³è™Ÿæˆ–ä¿¡ç®±'; } 
            })
            .catch(error => { msgDiv.innerText = 'æŸ¥è©¢å¤±æ•—ï¼š' + error.message; });
    }
    
    function setQrCountOptions() { 
        const select = document.getElementById('qrCount'); 
        const currentSelectedValue = select.value; 
        const generateBtn = document.getElementById("generateBtn"); 
        select.innerHTML = ""; 
        if (isQuotaUnlimited) { 
            const option = document.createElement('option'); 
            option.value = 1; 
            option.textContent = "1 (ç„¡é™ï¼Œä¸æä¾›ä¸‹è¼‰)"; 
            select.appendChild(option); 
            select.disabled = true; 
            generateBtn.disabled = false; 
        } else { 
            const max = Math.min(40, currentUserProfile.downloadQuota); 
            for (let i = 1; i <= max; i++) { 
                const option = document.createElement('option'); 
                option.value = i; 
                option.textContent = i; 
                select.appendChild(option); 
            } 
            select.value = (currentSelectedValue && parseInt(currentSelectedValue, 10) <= max) ? currentSelectedValue : (max > 0 ? 1 : ''); 
            select.disabled = (max === 0); 
            generateBtn.disabled = (max === 0); 
        } 
        updateButtonLabels(); 
    }
    
    function showCustomAlert(msg) { 
        document.getElementById('customAlertButtons').innerHTML = '<button onclick="closeCustomAlert()">ç¢ºå®š</button>'; 
        document.getElementById('customAlertMsg').innerHTML = String(msg).replace(/\n/g, '<br>'); 
        document.getElementById('customAlert').style.display = 'flex'; 
    }
    
    function closeCustomAlert() { document.getElementById('customAlert').style.display = 'none'; }
    function updateButtonLabels() { document.getElementById("generateBtn").textContent = `æ¢ç¢¼ç”¢ç”Ÿå™¨ (${document.getElementById('qrCount').value || 0})`; }
    
    function validateInputs() { 
        if (!document.getElementById('bankSelect').value) { showCustomAlert("è«‹é¸æ“‡ä¸€å€‹éŠ€è¡Œï¼"); return false; }
        const first = document.getElementById('firstBarcode').value.trim(); 
        const second = document.getElementById('secondBarcode').value.trim(); 
        const paymentDue = document.getElementById("paymentDue").value.trim(); 
        const amt = document.getElementById("paymentAmount").value.trim(); 
        let msg = ""; 
        if (first.length !== 9) msg += "ç¬¬ä¸€æ®µæ¢ç¢¼å¿…é ˆç‚º9ç¢¼ï¼\n"; 
        if (second.length !== 16) msg += "ç¬¬äºŒæ®µæ¢ç¢¼å¿…é ˆç‚º16ç¢¼ï¼\n"; 
        if (!paymentDue || !amt) msg += "ç¹³è²»æœŸé™å’Œé‡‘é¡ç‚ºå¿…å¡«æ¬„ä½ï¼\n"; 
        if (msg) { showCustomAlert(msg.trim()); return false; } 
        if (!isValidMinguoDate(paymentDue)) { showCustomAlert("ç¹³è²»æœŸé™æ ¼å¼éŒ¯èª¤ï¼Œè«‹è¼¸å…¥æ­£ç¢ºçš„æ°‘åœ‹æ—¥æœŸ (YYYMMDD)"); return false; } 
        if (!serverDateInfo) { showCustomAlert("ç„¡æ³•ç²å–ä¼ºæœå™¨æ™‚é–“ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–é‡æ–°ç™»å…¥ã€‚"); return false; } 
        const inputYear = parseInt(paymentDue.substring(0, 3), 10); 
        const serverYear = serverDateInfo.year; 
        if (serverDateInfo.month === 12) { 
            if (inputYear !== serverYear && (inputYear !== serverYear + 1 || parseInt(paymentDue.substring(3, 5), 10) !== 1)) {
                showCustomAlert(`ç¹³è²»æœŸé™éŒ¯èª¤ï¼š\nè·¨å¹´æœŸé–“ï¼Œå¹´ä»½åªèƒ½è¼¸å…¥ ${serverYear} æˆ– ${serverYear + 1} å¹´ 1 æœˆã€‚`); 
                return false;
            }
        } else { 
            if (inputYear !== serverYear) { 
                showCustomAlert(`ç¹³è²»æœŸé™éŒ¯èª¤ï¼š\nç›®å‰åªå…è¨±è¼¸å…¥ ${serverYear} å¹´çš„æ—¥æœŸã€‚`); 
                return false; 
            } 
        }
        return true; 
    }
    
    function isValidMinguoDate(dateStr) { 
        if (!/^[0-9]{7}$/.test(dateStr)) return false; 
        const year = parseInt(dateStr.substring(0, 3), 10) + 1911; 
        const month = parseInt(dateStr.substring(3, 5), 10); 
        const day = parseInt(dateStr.substring(5, 7), 10); 
        if (month < 1 || month > 12) return false; 
        return day >= 1 && day <= new Date(year, month, 0).getDate(); 
    }

    function generateRequestKey() { 
        const data = [
            document.getElementById('firstBarcode').value.trim(), 
            document.getElementById('secondBarcode').value.trim(), 
            document.getElementById("paymentDue").value.trim(), 
            document.getElementById("paymentAmount").value.trim(), 
            document.getElementById('qrCount').value, 
            userRow, 
            userSource
        ].join('|');
        return btoa(encodeURIComponent(data)); 
    }
    
    function updateQuotaDisplay() { document.getElementById('quotaDisplay').innerText = isQuotaUnlimited ? 'ç„¡é™' : (currentUserProfile.downloadQuota || 0); }
    
    function onFirstBarcodeInput() { 
        clearPreviews(); 
        const val = document.getElementById('firstBarcode').value.trim(); 
        const bankNameSpan = document.getElementById('bankName'); 
        if (val.length === 9) { 
            const code = val.slice(-3); 
            callBackend('getBankNameByCode', [code]).then(name => { bankNameSpan.innerText = name ? `éŠ€è¡Œï¼š${name}` : ''; });
        } else { 
            bankNameSpan.innerText = ''; 
        } 
    }
    
    function onBankSelectChange() {
        const isOther = document.getElementById('bankSelect').value === 'other';
        document.getElementById('bankInput').style.display = isOther ? 'block' : 'none';
        document.getElementById('bankLabel').style.display = isOther ? 'block' : 'none';
        clearPreviews();
    }
        
    function loadBankSelect() { 
        callBackend('getBankNames')
            .then(data => {
                const banks = data || [];
                const select = document.getElementById('bankSelect');
                const otherOption = select.querySelector('option[value="other"]'); 
                while (select.options.length > 2) { select.remove(1); }
                banks.forEach(name => { 
                    const opt = document.createElement('option'); 
                    opt.value = name; 
                    opt.textContent = name; 
                    select.insertBefore(opt, otherOption);
                }); 
            })
            .catch(error => {
                console.error("è¼‰å…¥éŠ€è¡Œåˆ—è¡¨å¤±æ•—:", error.message);
                showCustomAlert("ç„¡æ³•è¼‰å…¥éŠ€è¡Œåˆ—è¡¨ï¼Œè«‹ç¢ºèªå¾Œç«¯è¨­å®šæ˜¯å¦æ­£ç¢ºã€‚");
            });
    }

    function sendLegacyVerification() {
        const email = document.getElementById('legacyEmail').value.trim();
        if (!email) { document.getElementById('legacyVerifyMsg').innerText = 'è«‹è¼¸å…¥æ‚¨çš„ä¿¡ç®±ã€‚'; return; }
        document.getElementById('legacyVerifyMsg').innerText = 'æ­£åœ¨ç™¼é€é©—è­‰ç¢¼...';
        callBackend('resendVerificationForLegacyUser', [accountToVerify, email])
            .then(res => {
                if(res.success) {
                    document.getElementById('legacyVerifyBox').style.display = 'none';
                    document.getElementById('verifyBox').style.display = 'flex';
                    document.getElementById('verifyInfoMsg').innerHTML = `æˆ‘å€‘å·²ç™¼é€ä¸€çµ„ 6 ä½æ•¸é©—è­‰ç¢¼åˆ° <strong style="color: #007bff;">${res.email}</strong>ï¼Œ<br>è«‹åœ¨ 10 åˆ†é˜å…§è¼¸å…¥ä»¥å®Œæˆé©—è­‰ã€‚`;
                } else {
                    document.getElementById('legacyVerifyMsg').innerText = res.message || 'ç™¼é€å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚';
                }
            })
            .catch(error => { document.getElementById('legacyVerifyMsg').innerText = 'ç™¼é€å¤±æ•—ï¼š' + error.message; });
    }

    function verifyCode() {
        const code = document.getElementById('verifyCode').value.trim();
        if (!code || code.length !== 6) { document.getElementById('verifyMsg').innerText = 'è«‹è¼¸å…¥ 6 ä½æ•¸é©—è­‰ç¢¼ã€‚'; return; }
        document.getElementById('verifyMsg').innerText = 'é©—è­‰ä¸­...';
        callBackend('verifyEmailCode', [accountToVerify, code])
            .then(res => {
                if (res.success) {
                    showCustomAlert('ä¿¡ç®±é©—è­‰æˆåŠŸï¼\nç¾åœ¨æ‚¨å¯ä»¥ç™»å…¥äº†ã€‚');
                    showLogin();
                } else {
                    document.getElementById('verifyMsg').innerText = res.message || 'é©—è­‰å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚';
                }
            })
            .catch(err => { document.getElementById('verifyMsg').innerText = 'é©—è­‰å¤±æ•—ï¼š' + err.message; });
    }
    
    function showProfile() {
      if (!currentUserProfile) { showCustomAlert("ç„¡æ³•ç²å–æœƒå“¡è³‡æ–™ï¼Œè«‹é‡æ–°ç™»å…¥ã€‚"); return; }
      document.getElementById('profileAccount').textContent = currentUserProfile.account;
      document.getElementById('profileEmail').value = currentUserProfile.email;
      document.getElementById('profileQuota').textContent = isQuotaUnlimited ? 'ç„¡é™ (ä¸æä¾›ä¸‹è¼‰)' : currentUserProfile.downloadQuota;
      document.getElementById('profileRegisterDate').textContent = currentUserProfile.registerDate || 'N/A';
      document.getElementById('profileLastModified').textContent = currentUserProfile.lastModified || 'ç„¡ä¿®æ”¹ç´€éŒ„';
      document.getElementById('profilePassword').value = '';
      document.getElementById('profileMsg').textContent = '';
      const saveBtn = document.getElementById('saveProfileBtn');
      const cooldownDays = 90;
      if (currentUserProfile.lastModified) {
        const lastModifiedDate = new Date(currentUserProfile.lastModified.replace(' ', 'T'));
        const daysSinceLastChange = (new Date() - lastModifiedDate) / (1000 * 60 * 60 * 24);
        saveBtn.disabled = daysSinceLastChange < cooldownDays;
        if (daysSinceLastChange < cooldownDays) {
          document.getElementById('profileMsg').textContent = `è³‡æ–™ä¿®æ”¹å†·å»ä¸­ï¼Œå‰©é¤˜ ${Math.ceil(cooldownDays - daysSinceLastChange)} å¤©ã€‚`;
        }
      } else {
        saveBtn.disabled = false;
      }
      document.getElementById('cancelProfileBtn').style.display = currentUserProfile.email ? 'inline-block' : 'none';
      showLogin(); // clean slate
      document.getElementById('loginBox').style.display = 'none';
      document.getElementById('profileBox').style.display = 'flex';
    }

    function hideProfile() {
      if (!currentUserProfile.email) { showCustomAlert("è«‹å‹™å¿…å¡«å¯«ä¸¦å„²å­˜æ‚¨çš„ä¿¡ç®±è³‡æ–™ã€‚"); return; }
      document.getElementById('profileBox').style.display = 'none';
      showMainAppPage();
    }

    function saveProfile() {
      const newPassword = document.getElementById('profilePassword').value;
      const newEmail = document.getElementById('profileEmail').value.trim();
      const profileMsg = document.getElementById('profileMsg');
      if (!newEmail) { profileMsg.textContent = 'ä¿¡ç®±ä¸èƒ½ç‚ºç©ºã€‚'; return; }
      if (newPassword && !validatePassword(newPassword)) { profileMsg.textContent = 'æ–°å¯†ç¢¼æ ¼å¼ä¸ç¬¦åˆè¦æ±‚ã€‚'; return; }
      const newData = {};
      if (newPassword) newData.newPassword = newPassword;
      if (newEmail !== currentUserProfile.email) newData.newEmail = newEmail;
      if (Object.keys(newData).length === 0 && currentUserProfile.email) { profileMsg.textContent = 'è³‡æ–™æœªè®Šæ›´ã€‚'; return; }
      profileMsg.textContent = 'å„²å­˜ä¸­...';
      callBackend('updateUserProfile', [userSource, userRow, newData])
        .then(res => {
          if (res.success) {
            if (newData.newEmail) currentUserProfile.email = newData.newEmail;
            currentUserProfile.lastModified = new Date().toISOString().slice(0, 16).replace('T', ' ');
            profileMsg.textContent = res.message;
            document.getElementById('cancelProfileBtn').style.display = 'inline-block';
            setTimeout(hideProfile, 1500);
          } else { profileMsg.textContent = res.message; }
        })
        .catch(err => { profileMsg.textContent = 'æ›´æ–°å¤±æ•—ï¼š' + err.message; });
    }

    function validatePassword(password) {
      return /^(?=.*[a-z])(?=.*[A-Z])(?=.*[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]).{8,}$/.test(password);
    }
    
    function login() {
        const account = document.getElementById('loginAccount').value.trim();
        const password = document.getElementById('loginPassword').value.trim();
        if (!account || !password) { document.getElementById('loginMsg').innerText = 'å¸³è™Ÿå’Œå¯†ç¢¼ä¸èƒ½ç‚ºç©º'; return; }
        document.getElementById('loginMsg').innerText = 'ç™»å…¥ä¸­...';
        callBackend('checkLogin', [account, password])
            .then(res => {
                if (res && res.success) {
                    apiToken = res.token; 
                    userRow = res.row; 
                    userSource = res.source; 
                    currentUserProfile = res.profile;
                    isQuotaUnlimited = (currentUserProfile.downloadQuota <= 0);
                    updateQuotaDisplay(); 
                    setQrCountOptions(); 
                    updateButtonLabels();
                    if (userSource === 'ç®¡ç†è€…') {
                        document.getElementById('adminBtn').style.display = 'inline-block';
                        document.getElementById('userAdminBtn').style.display = 'inline-block';
                    } else {
                        document.getElementById('adminBtn').style.display = 'none';
                        document.getElementById('userAdminBtn').style.display = 'none';
                    }
                    callBackend('getCurrentRocDateInfo').then(dateInfo => { serverDateInfo = dateInfo; });
                    showMainAppPage();
                } else {
                    document.getElementById('loginMsg').innerText = ''; // Clear "Logging in..."
                    if (res && res.reason === 'legacy_user') {
                        accountToVerify = account;
                        document.getElementById('loginBox').style.display = 'none';
                        document.getElementById('legacyVerifyBox').style.display = 'flex';
                        document.getElementById('legacyEmail').value = res.email || '';
                        document.getElementById('legacyVerifyMsg').innerText = '';
                    } else if (res && res.reason === 'unverified') {
                        accountToVerify = account;
                        document.getElementById('loginBox').style.display = 'none';
                        document.getElementById('verifyBox').style.display = 'flex';
                        document.getElementById('verifyInfoMsg').innerHTML = `æ­¤å¸³è™Ÿ <strong style="color: #007bff;">${accountToVerify}</strong> å°šæœªå®Œæˆä¿¡ç®±é©—è­‰ã€‚<br>è«‹è¼¸å…¥æˆ‘å€‘ä¹‹å‰å¯„é€çš„é©—è­‰ç¢¼ï¼Œæˆ–é‡æ–°è¨»å†Šã€‚`;
                    } else {
                        document.getElementById('loginMsg').innerText = (res && res.message) ? res.message : 'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤';
                    }
                }
            })
            .catch(e => { document.getElementById('loginMsg').innerText = 'ç™»å…¥å¤±æ•—ï¼š' + e.message; });
    }
    
    function register() {
        const account = document.getElementById('registerAccount').value.trim();
        const password = document.getElementById('registerPassword').value.trim();
        const email = document.getElementById('registerEmail').value.trim();
        const serial = document.getElementById('registerSerial').value.trim();
        const msgDiv = document.getElementById('registerMsg');
        if (!account || !password || !email || !serial) { msgDiv.innerText = 'æ‰€æœ‰æ¬„ä½çš†ç‚ºå¿…å¡«'; return; }
        if (!validatePassword(password)) { msgDiv.innerText = 'å¯†ç¢¼æ ¼å¼ä¸ç¬¦ï¼Œè«‹ç¢ºèªæ ¼å¼'; return; }
        msgDiv.innerText = 'è¨»å†Šä¸­...';
        callBackend('registerUser', [{ username: account, password, email, serial }])
            .then(res => {
                msgDiv.innerText = ''; // Clear "Registering..."
                if (res.result === 'success_pending_verification') {
                    accountToVerify = account;
                    document.getElementById('registerBox').style.display = 'none';
                    document.getElementById('verifyBox').style.display = 'flex';
                    document.getElementById('verifyInfoMsg').innerHTML = `æˆ‘å€‘å·²ç™¼é€ä¸€çµ„ 6 ä½æ•¸é©—è­‰ç¢¼åˆ° <strong style=\"color: #007bff;\">${email}</strong>ï¼Œ<br>è«‹åœ¨ 10 åˆ†é˜å…§è¼¸å…¥ä»¥å®Œæˆé©—è­‰ã€‚`;
                } else if (res.result === 'invalid_serial' || res.result === 'serial_full') {
                    msgDiv.innerText = 'è¨»å†Šç¢¼ç„¡æ•ˆæˆ–å·²ç”¨å®Œï¼Œè«‹ç¢ºèªã€‚';
                } else if (res.result === 'user_exists') {
                    msgDiv.innerText = 'æ­¤å¸³è™Ÿå·²è¢«è¨»å†Šã€‚';
                } else if (res.result === 'email_exists') {
                    msgDiv.innerText = 'æ­¤ä¿¡ç®±å·²è¢«è¨»å†Šã€‚';
                } else {
                    msgDiv.innerText = (res && res.message) ? res.message : 'è¨»å†Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
                }
            })
            .catch(err => { msgDiv.innerText = 'è¨»å†Šå¤±æ•—ï¼š' + err.message; });
    }

    function showAdminPanel() {
        showLogin(); // clean slate
        document.getElementById('loginBox').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'flex';
        document.getElementById('adminMsg').innerText = '';
        loadSerialCodes();
    }

    function hideAdminPanel() {
        document.getElementById('adminPanel').style.display = 'none';
        showMainAppPage();
    }

    function loadSerialCodes() {
        const tbody = document.getElementById('serialTableBody');
        tbody.innerHTML = '<tr><td colspan="4">è¼‰å…¥ä¸­...</td></tr>';
        callBackend('getSerialCodes', [userSource])
            .then(data => {
                tbody.innerHTML = '';
                if (data) { data.forEach(row => addSerialRow(row[0], row[1], row[2])); }
            })
            .catch(err => { tbody.innerHTML = `<tr><td colspan="4" style="color:red;">è¼‰å…¥å¤±æ•—: ${err.message}</td></tr>`; });
    }

    function addSerialRow(serial = '', total = '', used = '') {
        const newRow = document.getElementById('serialTableBody').insertRow();
        newRow.innerHTML = `<td><input type="text" class="serial-input" value="${serial}"></td><td><input type="number" class="total-input" value="${total}"></td><td><input type="number" class="used-input" value="${used}"></td><td><button class="delete-row-btn">åˆªé™¤</button></td>`;
    }

    function deleteSerialRow(btn) { btn.closest('tr').remove(); }

    function saveSerialCodes() {
        const adminMsg = document.getElementById('adminMsg');
        adminMsg.innerText = 'å„²å­˜ä¸­...';
        let serialData = [], hasError = false;
        document.querySelectorAll('#serialTableBody tr').forEach((row, i) => {
            if (hasError) return;
            const serial = row.cells[0].querySelector('input').value.trim();
            const total = row.cells[1].querySelector('input').value.trim();
            if (serial) {
                if (total === '' || isNaN(total)) {
                    adminMsg.innerText = `éŒ¯èª¤ï¼šç¬¬ ${i + 1} è¡Œçš„ã€Œç¸½æ¬¡æ•¸ã€å¿…é ˆæ˜¯æ•¸å­—ã€‚`;
                    hasError = true;
                } else {
                    serialData.push([serial, Number(total), Number(row.cells[2].querySelector('input').value.trim()) || 0]);
                }
            }
        });
        if (hasError) return;
        callBackend('updateSerialCodes', [userSource, serialData])
            .then(res => {
                adminMsg.innerText = res.message;
                if (res.success) { setTimeout(() => { adminMsg.innerText = ''; }, 2000); }
            })
            .catch(err => { adminMsg.innerText = 'å„²å­˜å¤±æ•—: ' + err.message; });
    }
    
    function showUserAdminPanel() {
        showLogin(); // clean slate
        document.getElementById('loginBox').style.display = 'none';
        document.getElementById('userAdminPanel').style.display = 'flex';
        document.getElementById('userAdminMsg').innerText = '';
        loadUsersForAdmin();
    }
    
    function hideUserAdminPanel() {
        document.getElementById('userAdminPanel').style.display = 'none';
        showMainAppPage();
    }

    function loadUsersForAdmin() {
        const tbody = document.getElementById('userTableBody');
        tbody.innerHTML = '<tr><td colspan="5">è¼‰å…¥ä¸­...</td></tr>';
        callBackend('getUsersForAdmin')
            .then(users => {
                tbody.innerHTML = '';
                if (users && users.length > 0) {
                    users.forEach(user => {
                        const newRow = tbody.insertRow();
                        newRow.innerHTML = `<td>${user.account}</td><td><input type="checkbox" ${user.qrPermission ? 'checked' : ''}></td><td><input type="number" value="${user.currentQuota}"></td><td><input type="number" value="${user.resetQuota}"></td><td>${user.registerDate || 'N/A'}</td>`;
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="5">æ²’æœ‰ä½¿ç”¨è€…è³‡æ–™ã€‚</td></tr>';
                }
            })
            .catch(err => { tbody.innerHTML = `<tr><td colspan="5" style="color:red;">è¼‰å…¥å¤±æ•—: ${err.message}</td></tr>`; });
    }

    function saveUsersByAdmin() {
        const msgDiv = document.getElementById('userAdminMsg');
        msgDiv.innerText = 'å„²å­˜ä¸­...';
        const usersData = Array.from(document.querySelectorAll('#userTableBody tr')).map(row => ({
            account: row.cells[0].innerText,
            qrPermission: row.cells[1].querySelector('input').checked,
            currentQuota: Number(row.cells[2].querySelector('input').value),
            resetQuota: Number(row.cells[3].querySelector('input').value)
        }));
        callBackend('updateUsersByAdmin', [usersData])
            .then(res => {
                msgDiv.innerText = res.message;
                if (res.success) { setTimeout(() => { msgDiv.innerText = ''; }, 2000); }
            })
            .catch(err => { msgDiv.innerText = 'å„²å­˜å¤±æ•—: ' + err.message; });
    }

    // â–¼â–¼â–¼ ç¬¬äºŒéƒ¨åˆ†ï¼šäº‹ä»¶ç¶å®š (DOMContentLoadedç¢ºä¿HTMLè¼‰å…¥å®Œæˆ) â–¼â–¼â–¼
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('loginBtn').addEventListener('click', login);
        document.getElementById('registerBtn').addEventListener('click', register);
        document.getElementById('barcodeForm').addEventListener('submit', function(event) { event.preventDefault(); handleGenerateClick(); });
        document.getElementById('downloadAllBtn').addEventListener('click', startDownloadProcess);
        document.getElementById('backToGeneratorBtn').addEventListener('click', showMainAppPage);
        document.getElementById('showRegisterBtn').addEventListener('click', showRegister);
        document.getElementById('registerBackToLoginBtn').addEventListener('click', showLogin);
        document.getElementById('showForgotBtn').addEventListener('click', showForgotBox);
        document.getElementById('forgotBackBtn').addEventListener('click', hideForgotBox);
        document.getElementById('forgotSendBtn').addEventListener('click', forgotPassword);
        document.getElementById('verifyBtn').addEventListener('click', verifyCode);
        document.getElementById('verifyBackToLoginBtn').addEventListener('click', showLogin);
        document.getElementById('legacySendBtn').addEventListener('click', sendLegacyVerification);
        document.getElementById('legacyLaterBtn').addEventListener('click', showLogin);
        document.getElementById('showProfileBtn').addEventListener('click', showProfile);
        document.getElementById('saveProfileBtn').addEventListener('click', saveProfile);
        document.getElementById('cancelProfileBtn').addEventListener('click', hideProfile);
        document.getElementById('adminBtn').addEventListener('click', showAdminPanel);
        document.getElementById('cancelAdminBtn').addEventListener('click', hideAdminPanel);
        document.getElementById('addRowBtn').addEventListener('click', () => addSerialRow());
        document.getElementById('saveSerialsBtn').addEventListener('click', saveSerialCodes);
        document.getElementById('serialTableBody').addEventListener('click', function(event) { if (event.target.classList.contains('delete-row-btn')) { deleteSerialRow(event.target); } });
        document.getElementById('userAdminBtn').addEventListener('click', showUserAdminPanel);
        document.getElementById('saveUsersBtn').addEventListener('click', saveUsersByAdmin);
        document.getElementById('cancelUserAdminBtn').addEventListener('click', hideUserAdminPanel);
        document.getElementById('firstBarcode').addEventListener('input', onFirstBarcodeInput);
        document.getElementById('secondBarcode').addEventListener('input', clearPreviews);
        document.getElementById('paymentDue').addEventListener('input', clearPreviews);
        document.getElementById('paymentAmount').addEventListener('input', clearPreviews);
        document.getElementById('bankSelect').addEventListener('change', onBankSelectChange);
        document.getElementById('qrCount').addEventListener('change', updateButtonLabels);
        document.getElementById('amountIncrementType').addEventListener('change', function() {
            document.getElementById('customIncrementAmount').style.display = (this.value === 'custom') ? 'block' : 'none';
        });
        loadBankSelect();
    });
  </script>
</body>
</html>
