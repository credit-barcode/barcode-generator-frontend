<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>繳費條碼</title>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; padding: 1rem; font-family: Arial, sans-serif; display: flex; flex-direction: column; align-items: center; background-color: #f4f4f4; }
    h2, h3 { text-align: center; }
    p { font-size: 1rem; font-weight: bold; color: red; text-align: center; margin-bottom: 1rem; }
    form { width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 0.5rem; margin: 0 auto 1rem auto; text-align: center; }
    input, select, button { font-size: 1rem; padding: 0.5rem; width: 100%; border-radius: 6px; border: 1px solid #ccc; }
    button { background-color: #4CAF50; color: white; border: none; cursor: pointer; font-weight: bold; }
    button:hover { background-color: #45a049; }
    button:disabled { background-color: #cccccc; cursor: not-allowed; }
    .preview-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 1rem; width: 100%; max-width: 1200px; margin: 1rem auto; }
    .qr-wrapper { display: flex; flex-direction: column; background-color: #fff; padding: 28px 24px 20px 24px; border: 1px solid #ccc; border-radius: 12px; width: 500px; margin: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: relative; }
    .qr-wrapper .serial-number { position: absolute; top: 18px; right: 24px; background-color: #4CAF50; color: white; font-weight: bold; font-size: 16px; border-radius: 50%; min-width: 32px; height: 32px; display: flex; justify-content: center; align-items: center; padding: 0 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    .qr-wrapper .barcode-title { font-weight: bold; text-align: center; margin-bottom: 24px; font-size: 24px; }
    .qr-wrapper .barcode-reminder { color:orange; font-weight:bold; font-size:16px; text-align:center; margin-top:18px; }
    @media screen and (max-width: 600px) { .qr-wrapper { width: 100%; margin: 10px 0; } }
    #loginBox, #registerBox, #forgotBox, #verifyBox, #legacyVerifyBox { width: 90vw; max-width: 340px; margin: 40px auto; padding: 24px 16px; border: 1px solid #ccc; border-radius: 12px; box-shadow: 0 2px 8px #0001; background: #fff; display: flex; flex-direction: column; align-items: center; }
    #loginBox h3, #registerBox h3, #forgotBox h3, #verifyBox h3, #legacyVerifyBox h3 { margin: 0 0 18px 0; font-size: 1.3rem; text-align: center; font-weight: bold; }
    #loginBox .form-group, #registerBox .form-group, #profileBox .form-group, #verifyBox .form-group, #legacyVerifyBox .form-group { width: 100%; margin-bottom: 16px; text-align: left; position: relative; }
    #loginBox input, #registerBox input, #forgotBox input, #verifyBox input, #legacyVerifyBox input { width: 100%; padding: 12px; font-size: 1.1rem; }
    #loginBox button, #registerBox button, #forgotBox button, #verifyBox button, #legacyVerifyBox button { width: 100%; padding: 12px; font-size: 1.1rem; margin-top: 4px; }
    #loginMsg, #registerMsg, #forgotMsg, #verifyMsg, #legacyVerifyMsg { color: red; margin-top: 12px; text-align: center; font-size: 1rem; min-height: 1.2rem; }
    #mainApp, #previewPage { display: none; width: 100%; max-width: 800px; margin: 0 auto; text-align: center; padding: 1rem; }
    .preview-actions { display: flex; justify-content: center; align-items: center; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
    .download-button-container { text-align: center; margin-top: 0; }
    #downloadAllBtn { width: auto !important; min-width: 150px; display: none; padding: 8px 24px; font-size: 1rem; background-color: #dc3545; margin: 0 auto; }
    #backToGeneratorBtn { width: auto; padding: 8px 24px; font-size: 1rem; background-color: #6c757d; margin-top: 0; }
    #customAlert { display: none; position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; z-index: 9999; background: rgba(0,0,0,0.4); justify-content: center; align-items: center; }
    #customAlertBox { background: #fff; padding: 32px 24px 28px 24px; border-radius: 16px; max-width: 90vw; min-width: 320px; box-shadow: 0 4px 15px rgba(0,0,0,0.18); text-align: center; font-family: inherit; }
    #customAlertMsg { margin-bottom: 18px; font-size: 1.15em; line-height: 1.6; }
    #customAlertButtons { display: flex; justify-content: center; gap: 1.5em; align-items: center; margin-top: 0.5em; }
    #customAlertBox button { padding: 10px 38px; font-size: 1.1em; border-radius: 8px; border: none; font-weight: bold; margin: 0 0.2em; transition: background 0.2s; cursor: pointer; }
    #customAlertBox #confirmBtn { background: #e53935; color: #fff; }
    #customAlertBox #cancelBtn { background: #757d87; color: #fff; }
    #customAlertBox button:not(#confirmBtn):not(#cancelBtn) { background-color: #4CAF50; color: white; }
    .download-alert-title { color: #e53935; font-size: 1.25em; font-weight: bold; margin-bottom: 0.5em; letter-spacing: 1px; }
    .download-alert-desc { color: #222; font-size: 1.08em; margin-bottom: 0.5em; font-weight: 500; }
    .download-alert-list-title { font-size: 1.1em; font-weight: bold; margin: 1em 0 0.5em 0; letter-spacing: 1px; }
    .download-alert-checkboxes { display: flex; flex-direction: column; align-items: flex-start; gap: 0.5em; margin: 0.5em auto 1.2em auto; font-size: 1em; width: fit-content; }
    .download-alert-checkboxes label { display: flex; align-items: center; gap: 0.5em; font-size: 1em; font-weight: 500; cursor: pointer; user-select: none; }
    .download-alert-checkboxes input[type="checkbox"] { width: 18px; height: 18px; accent-color: #e53935; flex-shrink: 0; }
    @media (max-width: 480px) { #customAlertBox { min-width: 90vw; padding: 18px 4vw 18px 4vw; } .download-alert-checkboxes label { font-size: 0.98em; } #customAlertBox button { font-size: 1em; padding: 8px 0; width: 44vw; } }
    #profileBox { display: none; width: 90vw; max-width: 400px; margin: 40px auto; padding: 24px; border: 1px solid #ccc; border-radius: 12px; box-shadow: 0 2px 8px #0001; background: #fff; flex-direction: column; align-items: center; }
    #profileBox h3 { margin: 0 0 24px 0; font-size: 1.3rem; text-align: center; font-weight: bold; }
    #profileBox .form-group label { display: block; font-weight: bold; margin-bottom: 6px; }
    #profileBox .form-group span { background-color: #eee; padding: 8px; display: inline-block; word-break: break-all; border-radius: 4px; width: 100%;}
    #profileBox .button-group { display: flex; gap: 1rem; width: 100%; margin-top: 10px; }
    #profileMsg { color: red; margin-top: 12px; text-align: left; font-size: 0.9rem; width:100%; }
    .input-hint { display: block; width: 100%; text-align: left; font-size: 0.8rem; color: #6c757d; margin-top: 4px; margin-bottom: 0; padding-left: 2px; }
    .uppercase-input { text-transform: uppercase; }
    #adminPanel, #userAdminPanel { display: none; width: 100%; max-width: 1000px; margin: 2rem auto; padding: 1.5rem; background: #fff; border: 1px solid #ccc; border-radius: 12px; flex-direction: column; }
    #adminPanel h3, #userAdminPanel h3 { margin: 0 0 1.5rem 0; }
    #serialTable, #userTable { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
    #serialTable th, #serialTable td, #userTable th, #userTable td { border: 1px solid #ddd; padding: 0.75rem; text-align: center; vertical-align: middle;}
    #serialTable th, #userTable th { background-color: #f2f2f2; }
    #serialTable input, #userTable input[type="number"] { width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; text-align: center; }
    #userTable input[type="checkbox"] { width: 20px; height: 20px; }
    #serialTable .delete-row-btn { background-color: #f44336; color: white; border: none; padding: 6px 10px; cursor: pointer; border-radius: 4px; }
    .admin-button-group { display: flex; flex-direction: column; gap: 0.5rem; width: 100%; margin-top: 1rem; }
  </style>
</head>
<body>

  <div id="loginBox">
    <h3>請先登入</h3>
    <div class="form-group">
      <input id="loginAccount" type="text" placeholder="帳號" />
    </div>
    <div class="form-group">
        <input type="password" id="loginPassword" placeholder="密碼" />
    </div>
    <button id="loginBtn">登入</button>
    <button type="button" id="showRegisterBtn" style="background-color:#6c757d;">註冊</button>
    <button type="button" id="showForgotBtn" style="background-color:#ffc107;color:#212529;">忘記密碼</button>
    <div id="loginMsg"></div>
  </div>

  <div id="registerBox" style="display:none;">
    <h3>註冊新帳號</h3>
    <div class="form-group">
      <input id="registerAccount" type="text" placeholder="帳號" />
    </div>
    <div class="form-group">
      <input type="password" id="registerPassword" placeholder="請輸入密碼" />
      <small class="input-hint">密碼至少8位，含大小寫英文及一個特殊符號</small>
    </div>
    <div class="form-group">
      <input id="registerEmail" type="email" placeholder="信箱" />
    </div>
    <div class="form-group">
      <input id="registerSerial" type="text" placeholder="註冊碼" />
    </div>
    <button id="registerBtn">確定註冊</button>
    <button id="registerBackToLoginBtn" style="background-color:#6c757d;">返回登入</button>
    <div id="registerMsg"></div>
  </div>

    <!-- index.html 中 id="verifyBox" 的部分 -->
    <div id="verifyBox" style="display:none;">
    <h3>請驗證您的信箱</h3>
    <p id="verifyInfoMsg" style="..."></p>
    <div class="form-group">
        <input id="verifyCode" type="text" placeholder="6 位數驗證碼" maxlength="6" />
    </div>
    <button id="verifyBtn">驗證</button>
    <!-- ▼▼▼ 【核心新增】 ▼▼▼ -->
    <button type="button" id="resendCodeBtn" style="background-color:#ffc107; color:#212529; font-size: 0.9em;">沒有收到？重新寄送驗證碼</button>
    <!-- ▲▲▲ 【核心新增】 ▲▲▲ -->
    <button id="verifyBackToLoginBtn" style="background-color:#6c757d;">返回登入</button>
    <div id="verifyMsg"></div>
    </div>

  <div id="legacyVerifyBox" style="display:none;">
    <h3>系統更新 - 請驗證信箱</h3>
    <p style="color:#333; font-weight:normal; font-size: 0.9em; line-height: 1.5; margin-bottom: 18px;">為提升帳戶安全，我們需要您完成信箱驗證。請確認或修改您的信箱，我們將發送一組驗證碼給您。</p>
    <div class="form-group">
      <input id="legacyEmail" type="email" placeholder="請確認或輸入新信箱" />
    </div>
    <button id="legacySendBtn">發送驗證碼</button>
    <button id="legacyLaterBtn" style="background-color:#6c757d;">稍後再說</button>
    <div id="legacyVerifyMsg"></div>
  </div>

  <div id="forgotBox" style="display:none;"><h3>忘記密碼</h3><input id="forgotAccount" type="text" placeholder="帳號" /><input id="forgotEmail" type="email" placeholder="註冊信箱" /><button id="forgotSendBtn">寄送密碼提示</button><button id="forgotBackBtn" style="background-color:#6c757d;">返回</button><div id="forgotMsg"></div></div>
  
  <div id="profileBox" style="display:none;">
    <h3>會員資料</h3>
    <div class="form-group"><label>帳號</label><span id="profileAccount"></span></div>
    <div class="form-group">
      <label for="profilePassword">新密碼 (不改請留空)</label>
      <input type="password" id="profilePassword" placeholder="請輸入新密碼">
      <small class="input-hint">密碼至少8位，含大小寫英文及一個特殊符號</small>
    </div>
    <div class="form-group"><label for="profileEmail">註冊信箱</label><input type="email" id="profileEmail" placeholder="請輸入您的信箱"></div>
    <div class="form-group"><label>剩餘下載額度</label><span id="profileQuota"></span></div>
    <div class="form-group"><label>註冊日期</label><span id="profileRegisterDate"></span></div>
    <div class="form-group"><label>最後修改日期</label><span id="profileLastModified"></span></div>
    <div id="profileMsg"></div>
    <div class="button-group"><button id="saveProfileBtn">儲存變更</button><button id="cancelProfileBtn" style="background-color:#6c757d;">返回主畫面</button></div>
  </div>

  <div id="mainApp">
      <div style="text-align: right; width: 100%; max-width: 800px; margin: 0 auto 1rem auto;">
          <button id="userAdminBtn" style="width: auto; padding: 8px 16px; background-color: #17a2b8; display: none; margin-right: 1rem;">使用者管理</button>
          <button id="adminBtn" style="width: auto; padding: 8px 16px; background-color: #ff9800; display: none; margin-right: 1rem;">管理註冊碼</button>
          <button id="showProfileBtn" style="width: auto; padding: 8px 16px; background-color: #007bff;">會員資料</button>
      </div>
      <div style="text-align: center; line-height: 1.8; border: 2px dashed red; padding: 10px; border-radius: 8px; margin-bottom: 1rem;">
          <p style="margin-bottom: 0.0em;">🚀 <strong>使用風險提醒</strong></p>
          <p style="margin: 0;">信用卡條碼產生器有可能會發生</p>
          <p style="margin: 0;">條碼掃得過但實際沒入帳</p>
          <p style="margin: 0;">付款紀錄「飛到外太空」不見了的情況</p>
          <p style="margin: 0;">請務必確認條碼內容正確無誤</p>
          <p style="margin-top: 0.0em;">⚠️風險需由您自行承擔!請小心使用</p>
      </div>
      <div style="font-size:0.95em;color:#555;margin-bottom:16px;">
          註解1. LINE內建瀏覽器，會導致部分功能無法操作。<br>
          註解2. 前4碼「年+月」有國泰、富邦、聯邦<br>
          註解3. 前4碼「月+日」有玉山、台新、台銀
      </div>
      <h2>條碼產生器</h2>
            <form id="barcodeForm">
                    <label>第三段條碼前4碼</label>
                    <select id="barcodeType">
                        <option value="YYMM">年+月</option>
                        <option value="MMDD">月+日</option>
                    </select>
                    <select id="bankSelect">
                        <option value="">請選擇銀行</option>
                        <option value="other">其他（請自行輸入）</option>
                    </select>
                    <label id="bankLabel" style="display:none;">請輸入銀行名稱</label>
                    <input type="text" id="bankInput" placeholder="請輸入銀行名稱" style="display:none;" />
                    <label>第一段條碼 (9碼)</label>
                    <input type="text" id="firstBarcode" maxlength="9" pattern="[A-Za-z0-9]{9}" title="請輸入 9 位英文或數字" required class="uppercase-input" />
                    <span id="bankName" style="color:blue;font-weight:bold;"></span>
                    <label>第二段條碼 (16碼) <span style="margin-left:8px;color: blue;">(銷帳編號)</span></label>
                    <input type="text" id="secondBarcode" maxlength="16" pattern="[A-Za-z0-9]{16}" title="請輸入 16 位英文或數字" required class="uppercase-input" placeholder="請謹慎確認" />
                    <label>繳費期限 (YYYMMDD)</label>
                    <input type="text" id="paymentDue" maxlength="7" pattern="^[0-9]{7}$" title="請輸入正確格式（YYYMMDD）" required />
                    
                    <label>繳費金額</label>
                    <input type="text" id="paymentAmount" pattern="^[0-9]+$" title="請輸入數字金額" required />
                    
                    <label>金額遞增</label>
                    <select id="amountIncrementType">
                        <option value="0">無 (金額固定)</option>
                        <option value="1">連續 +1 元</option>
                        <option value="5">連續 +5 元</option>
                        <option value="10">連續 +10 元</option>
                        <option value="custom">自訂</option>
                    </select>
                    <input type="number" id="customIncrementAmount" placeholder="請輸入自訂遞增金額" style="display:none;" />

                    <label>條碼數量 (剩餘 <span id="quotaDisplay">0</span> 張)</label>
                    <select id="qrCount"></select>
                    <button type="submit" id="generateBtn">條碼產生器</button>
            </form>
  </div>
  
  <div id="previewPage">
      <h2>繳費條碼</h2>
      <div class="preview-actions">
          <div class="download-button-container">
              <button id="downloadAllBtn">全部下載條碼</button>
          </div>
          <button id="backToGeneratorBtn">返回產生器</button>
      </div>
      <div class="preview-container" id="previewContainer"></div>
  </div>

  <div id="adminPanel">
    <h3>註冊碼管理</h3>
    <table id="serialTable">
      <thead>
        <tr>
          <th>序號</th>
          <th>總次數</th>
          <th>已用次數</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="serialTableBody">
      </tbody>
    </table>
    <div class="admin-button-group">
        <button id="addRowBtn">新增一列</button>
        <button id="saveSerialsBtn">儲存變更</button>
        <button id="cancelAdminBtn" style="background-color: #6c757d;">返回主畫面</button>
    </div>
    <div id="adminMsg" style="color: red; margin-top: 1rem; text-align: center;"></div>
  </div>
  
  <div id="userAdminPanel">
    <h3>使用者管理</h3>
    <table id="userTable">
      <thead>
        <tr>
          <th>帳號</th>
          <th>QR權限</th>
          <th>目前可用次數</th>
          <th>每月重設額度</th>
          <th>註冊日期</th>
        </tr>
      </thead>
      <tbody id="userTableBody">
      </tbody>
    </table>
    <div class="admin-button-group">
        <button id="saveUsersBtn">儲存變更</button>
        <button id="cancelUserAdminBtn" style="background-color: #6c757d;">返回主畫面</button>
    </div>
    <div id="userAdminMsg" style="color: red; margin-top: 1rem; text-align: center;"></div>
  </div>

  <div id="customAlert"><div id="customAlertBox"><div id="customAlertMsg"></div><div id="customAlertButtons"></div></div></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script>
    // ▼▼▼ 第一部分：所有函式定義 ▼▼▼

    // ▼ 全域變數 ▼
    let currentUserProfile = null;
    let accountToVerify = '';
    let generatedBarcodeData = []; // 用於儲存後端回傳的條碼資料
    
    /**
     * 向 Vercel 後端 API 發送 POST 請求的統一函式
     */
// index.html 中的 callApi 函式 (安全強化版)

/**
 * @typedef {Error & {json?: object}} ApiError
 */
// index.html 中的 callApi 函式 (最終安全版)

/**
 * @typedef {Error & {json?: object}} ApiError
 */
    function callApi(endpoint, data) {
    return fetch(`/api/${endpoint}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    }).then(response => {
        return response.json().then(json => {
        if (!response.ok) {
            // 將後端回傳的完整 JSON 物件附加到這個錯誤上
            const error = /** @type {ApiError} */ (new Error(json.message || `伺服器回傳 ${response.status}`));
            error.json = json; // 將完整的 json 附加到 error 物件上
            throw error;
        }
        return json;
        });
    });
    }
    
    // ▼ UI 顯示/隱藏控制函式 ▼
    function showLogin() {
        document.getElementById('profileBox').style.display = 'none';
        document.getElementById('registerBox').style.display = 'none';
        document.getElementById('forgotBox').style.display = 'none';
        document.getElementById('verifyBox').style.display = 'none';
        document.getElementById('legacyVerifyBox').style.display = 'none';
        document.getElementById('mainApp').style.display = 'none';
        document.getElementById('previewPage').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'none';
        document.getElementById('userAdminPanel').style.display = 'none';
        document.getElementById('loginBox').style.display = 'flex';
        document.getElementById('loginMsg').innerText = '';
    }

    function showRegister() {
        document.getElementById('loginBox').style.display = 'none';
        document.getElementById('registerBox').style.display = 'flex';
    }

    function showForgotBox() {
        document.getElementById('loginBox').style.display = 'none';
        document.getElementById('forgotBox').style.display = 'flex';
        document.getElementById('forgotMsg').innerText = '';
    }
    
    function hideForgotBox() {
        showLogin();
    }
    
    function showMainAppPage() {
        showLogin();
        document.getElementById('loginBox').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
    }

    function showPreviewPage() {
        showLogin();
        document.getElementById('loginBox').style.display = 'none';
        document.getElementById('previewPage').style.display = 'block';
    }

    // ▼ 彈出式提示框 ▼
    function showCustomAlert(msg) { 
        document.getElementById('customAlertButtons').innerHTML = '<button onclick="closeCustomAlert()">確定</button>'; 
        document.getElementById('customAlertMsg').innerHTML = String(msg).replace(/\n/g, '<br>'); 
        document.getElementById('customAlert').style.display = 'flex'; 
    }
    
    function closeCustomAlert() { 
        document.getElementById('customAlert').style.display = 'none'; 
    }

    // ▼ 核心功能函式 ▼
// index.html 中的 register 函式 (最終版本)

function register() {
    // 步驟 1: 從 HTML 表單中獲取使用者輸入的所有資料
    const account = document.getElementById('registerAccount').value.trim();
    const password = document.getElementById('registerPassword').value.trim();
    const email = document.getElementById('registerEmail').value.trim();
    const serial = document.getElementById('registerSerial').value.trim();
    const msgDiv = document.getElementById('registerMsg');
    
    // 清空上一次的錯誤訊息
    msgDiv.innerText = '';

    // 步驟 2: 在前端進行基本的輸入驗證
    // 檢查是否有任何欄位為空
    if (!account || !password || !email || !serial) {
        msgDiv.innerText = '所有欄位皆為必填';
        return; // 中斷函式執行
    }
    
    // 檢查密碼格式是否符合要求
    if (!validatePassword(password)) {
        msgDiv.innerText = '密碼格式不符，請確認格式';
        return; // 中斷函式執行
    }

    // 步驟 3: 更新 UI，提示使用者正在處理中
    msgDiv.innerText = '註冊中...';
    
    // 步驟 4: 使用 callApi 函式向後端 /api/register 端點發送請求
    callApi('register', { username: account, password, email, serial })
        .then(res => {
            // 步驟 5: 處理後端回傳的成功回應
            // 檢查後端回傳的結果是否為 'success_pending_verification'
            if (res.result === 'success_pending_verification') {
                // 清空「註冊中...」的提示
                msgDiv.innerText = '';
                // 將目前要驗證的帳號存到全域變數中，供驗證碼頁面使用
                accountToVerify = account;
                
                // 切換顯示的頁面：隱藏註冊頁面，顯示驗證碼輸入頁面
                document.getElementById('registerBox').style.display = 'none';
                document.getElementById('verifyBox').style.display = 'flex';
                
                // 更新驗證碼頁面的提示文字，告訴使用者要去哪裡收信
                document.getElementById('verifyInfoMsg').innerHTML = `我們已將一組 6 位數驗證碼寄送到 <strong style=\"color: #007bff;\">${email}</strong>，<br>請在 10 分鐘內輸入以完成驗證。`;
            }
        })
        .catch(err => {
            // 步驟 6: 處理後端回傳的錯誤回應
            // .catch() 會捕捉到所有後端回傳的非 2xx 狀態碼的錯誤
            // err.message 就是我們在後端 JSON 中定義的 message 內容
            // 例如：「註冊碼無效」、「此帳號已被註冊」等
            msgDiv.innerText = err.message;
        });
}
    
    // index.html 中的 login (最終版本)
    // index.html 中的 login 函式 (安全強化版)
    // index.html 中的 login 函式 (最終安全版)
    function login() {
        const account = document.getElementById('loginAccount').value.trim();
        const password = document.getElementById('loginPassword').value.trim();
        if (!account || !password) { 
            document.getElementById('loginMsg').innerText = '帳號和密碼不能為空';
            return; 
        }
        document.getElementById('loginMsg').innerText = '登入中...';
        
        callApi('login', { account, password })
            .then(res => {
                if (res.success && res.token) {
                    localStorage.setItem('authToken', res.token);
                    currentUserProfile = res.profile;
                    showMainAppPage();
                }
            })
            .catch(err => {
                // ▼▼▼ 【核心修正】 ▼▼▼
                // 現在我們可以安全地檢查 err.json 是否存在，以及它內部的 reason 屬性
                if (err.json && err.json.reason === 'unverified') {
                    // 如果是未驗證的錯誤，就引導使用者去驗證
                    accountToVerify = account;
                    document.getElementById('loginBox').style.display = 'none';
                    document.getElementById('verifyBox').style.display = 'flex';
                    document.getElementById('verifyInfoMsg').innerHTML = `此帳號 <strong style="color: #007bff;">${account}</strong> 尚未完成信箱驗證。<br>請檢查您的信箱以獲取驗證碼。`;
                    document.getElementById('loginMsg').innerText = '';
                } else {
                    // 如果是其他錯誤 (例如 401 密碼錯誤)，就顯示通用的錯誤訊息
                    document.getElementById('loginMsg').innerText = '登入失敗：' + err.message;
                }
                // ▲▲▲ 【核心修正】 ▲▲▲
            });
    }
    
    function loadBankSelect() {
      fetch('/api/getBanks')
        .then(response => {
          if (!response.ok) {
            return response.json().then(err => { throw new Error(err.error || '無法從伺服器獲取銀行列表。') });
          }
          return response.json();
        })
        .then(banks => {
          const select = document.getElementById('bankSelect');
          const otherOption = select.querySelector('option[value="other"]'); 
          while (select.options.length > 2) { select.remove(1); }
          if (banks && banks.length > 0) {
            banks.forEach(function(name) { 
              const opt = document.createElement('option'); 
              opt.value = name; 
              opt.textContent = name; 
              select.insertBefore(opt, otherOption);
            }); 
          }
        })
        .catch(error => {
          console.error("載入銀行列表失敗:", error);
          showCustomAlert("無法載入銀行列表，請確認後端設定是否正確。");
        });
    }

    function handleGenerateClick() { 
        // 為了讓 UI 能操作，暫時註解掉輸入驗證
        // if (!validateInputs()) return;
        
        showCustomAlert("正在後端計算條碼，請稍候...");
        
        const incrementType = document.getElementById('amountIncrementType').value;
        const incrementAmount = (incrementType === 'custom') ? (parseInt(document.getElementById('customIncrementAmount').value, 10) || 0) : parseInt(incrementType, 10);
        
        const params = {
            firstBarcode: document.getElementById("firstBarcode").value.trim().toUpperCase(),
            secondBarcode: document.getElementById("secondBarcode").value.trim().toUpperCase(),
            paymentDue: document.getElementById("paymentDue").value.trim(),
            paymentAmount: document.getElementById("paymentAmount").value.trim(),
            qrCount: parseInt(document.getElementById("qrCount").value, 10) || 1, // 確保有預設值
            barcodeType: document.getElementById("barcodeType").value,
            incrementAmount: incrementAmount,
        };

        callApi('generateBarcodes', params)
            .then(backendResult => {
                closeCustomAlert();
                generatedBarcodeData = backendResult;
                generatePreviewUI();
                showPreviewPage();
            })
            .catch(error => {
                closeCustomAlert();
                showCustomAlert("處理失敗：<br>" + error.message);
            });
    }

    function generatePreviewUI() {
        const container = document.getElementById("previewContainer");
        container.innerHTML = "";
        const downloadBtn = document.getElementById('downloadAllBtn');
        downloadBtn.style.display = 'none';

        if (!generatedBarcodeData || generatedBarcodeData.length === 0) return;
        
        // 預覽最多只顯示 10 筆
        const displayLimit = 10;
        generatedBarcodeData.slice(0, displayLimit).forEach(data => {
            const wrapper = createBarcodeWrapper(data, false, false);
            container.appendChild(wrapper);
            wrapper.querySelectorAll("canvas.barcode-canvas").forEach(canvas => {
                const barcodeValue = canvas.getAttribute('data-barcode');
                JsBarcode(canvas, barcodeValue, { format: "CODE128", displayValue: false, height: 50, width: 1.5, margin: 0, background: "transparent" });
            });
        });

        if (generatedBarcodeData.length > 0) {
            downloadBtn.textContent = `全部下載條碼 (${generatedBarcodeData.length})`;
            downloadBtn.style.display = 'inline-block';
        }
    }
    
    function createBarcodeWrapper(data, includeTitle, includeReminder) {
        const wrapper = document.createElement("div");
        wrapper.className = "qr-wrapper";
        const serialNumber = document.createElement("div");
        serialNumber.className = "serial-number";
        serialNumber.textContent = data.serial;
        wrapper.appendChild(serialNumber);
        if (includeTitle) {
            const title = document.createElement("div");
            title.className = "barcode-title";
            title.textContent = "超商繳費條碼";
            wrapper.appendChild(title);
        }
        data.barcodes.forEach((code, idx) => {
            const barcodeContainer = document.createElement("div");
            const marginBottomValue = (idx < 2) ? (includeTitle ? "40px" : "36px") : "0";
            let style = `margin-bottom: ${marginBottomValue}; text-align:center; overflow-x:auto; width:100%;`;
            if (!includeTitle && idx === 0) style += `padding-top: 10px;`;
            barcodeContainer.style.cssText = style;
            const canvas = document.createElement("canvas");
            canvas.className = "barcode-canvas";
            canvas.setAttribute('data-barcode', code);
            barcodeContainer.appendChild(canvas);
            const textDiv = document.createElement("div");
            textDiv.textContent = code;
            textDiv.style.cssText = "font-family: monospace; font-size: 22px; letter-spacing: 1px; margin-top: 4px;";
            barcodeContainer.appendChild(textDiv);
            wrapper.appendChild(barcodeContainer);
        });
        if (includeReminder) {
            const reminder = document.createElement("div");
            reminder.className = "barcode-reminder";
            reminder.textContent = "提醒您，超商繳款上限為2萬元。";
            wrapper.appendChild(reminder);
        }
        return wrapper;
    }
    
    function startDownloadProcess() {
        if (generatedBarcodeData.length === 0) { return showCustomAlert("沒有可下載的項目。"); }
        const msg = `<div class="download-alert-title">下載確認</div><div class="download-alert-desc">確定要下載全部 <b>${generatedBarcodeData.length}</b> 張圖檔嗎？</div><div class="download-alert-list-title">下載圖片含下列文字：</div><div class="download-alert-checkboxes"><label class="checkbox-label-align"><input type="checkbox" id="includeTitleForDownload" checked> 超商繳費條碼</label><label class="checkbox-label-align"><input type="checkbox" id="includeReminderForDownload" checked> 提醒您，超商繳款上限為2萬元。</label></div>`;
        const buttons = `<button id="cancelBtn" onclick="closeCustomAlert()">取消</button><button id="confirmBtn">確定</button>`;
        document.getElementById('customAlertMsg').innerHTML = msg;
        document.getElementById('customAlertButtons').innerHTML = buttons;
        document.getElementById('customAlert').style.display = 'flex';
        document.getElementById('confirmBtn').onclick = function() {
            closeCustomAlert();
            const includeTitle = document.getElementById('includeTitleForDownload').checked;
            const includeReminder = document.getElementById('includeReminderForDownload').checked;
            executeDownload(includeTitle, includeReminder);
        };
    }

    function executeDownload(includeTitle, includeReminder) {
        showCustomAlert("準備下載中，請稍候...");
        const zip = new JSZip();
        const tempContainer = document.createElement("div");
        tempContainer.style.cssText = "position: fixed; left: -9999px; top: 0; padding: 28px 24px 20px 24px;";
        document.body.appendChild(tempContainer);
        
        const promises = generatedBarcodeData.map(data => {
            return new Promise((resolve, reject) => {
                const wrapper = createBarcodeWrapper(data, includeTitle, includeReminder);
                tempContainer.appendChild(wrapper);
                
                setTimeout(() => {
                    try {
                        wrapper.querySelectorAll("canvas.barcode-canvas").forEach(canvas => {
                            JsBarcode(canvas, canvas.getAttribute('data-barcode'), { format: "CODE128", displayValue: false, height: 50, width: 1.5, margin: 0, background: "transparent" });
                        });
                        html2canvas(wrapper, { scale: 2 }).then(canvas => {
                            const base64 = canvas.toDataURL("image/png").split(',')[1];
                            zip.file(`信用卡帳單_${data.serial}.png`, base64, { base64: true });
                            tempContainer.removeChild(wrapper);
                            resolve();
                        }).catch(reject);
                    } catch (e) {
                        reject(e);
                    }
                }, 50);
            });
        });

        Promise.all(promises).then(() => {
            document.body.removeChild(tempContainer);
            if (Object.keys(zip.files).length > 0) {
                showCustomAlert("正在壓縮檔案...");
                zip.generateAsync({ type: "blob" }).then(content => {
                    saveAs(content, "信用卡帳單.zip");
                    closeCustomAlert();
                });
            } else { 
                showCustomAlert("沒有可下載的項目。"); 
            }
        }).catch(err => {
            document.body.removeChild(tempContainer);
            showCustomAlert('產生圖片失敗: ' + err.message);
        });
    }

    function validatePassword(password) {
      return /^(?=.*[a-z])(?=.*[A-Z])(?=.*[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]).{8,}$/.test(password);
    }
    
    // ▼ 尚未遷移或待重新設計的函式 ▼
    function clearPreviews() {}
    function forgotPassword() { showCustomAlert("忘記密碼功能正在升級中。"); }
    function setQrCountOptions() {
        // 暫時填充1-40個選項
        const select = document.getElementById('qrCount');
        select.innerHTML = '';
        for (let i = 1; i <= 40; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = i;
            select.appendChild(option);
        }
    }
    function updateButtonLabels() { 
        const count = parseInt(document.getElementById('qrCount').value, 10) || 1; 
        document.getElementById("generateBtn").textContent = `條碼產生器 (${count})`; 
    }
    function validateInputs() { return true; }
    function updateQuotaDisplay() { document.getElementById('quotaDisplay').innerText = currentUserProfile ? currentUserProfile.current_quota : 0; }
    function onFirstBarcodeInput() {}
    function onBankSelectChange() {}

    // index.html 的 <script> 區塊中
    function resendCode() {
        const msgDiv = document.getElementById('verifyMsg');
        msgDiv.innerText = '正在重新寄送...';
        
        callApi('resendCode', { account: accountToVerify })
            .then(res => {
                if (res.success) {
                    msgDiv.innerText = '';
                    showCustomAlert('新的驗證碼已成功寄出，請檢查您的信箱。');
                }
            })
            .catch(err => {
                msgDiv.innerText = err.message;
            });
    }

        // index.html 中的 verifyCode 函式 (最終版本)
    function verifyCode() {
        const code = document.getElementById('verifyCode').value.trim();
        const msgDiv = document.getElementById('verifyMsg');
        msgDiv.innerText = '';

        if (!code || code.length !== 6) {
            msgDiv.innerText = '請輸入 6 位數驗證碼。';
            return;
        }
        msgDiv.innerText = '驗證中...';
        
        // 使用 callApi 呼叫後端 /api/verifyCode 進行驗證
        // 我們將之前儲存的全域變數 accountToVerify 一起送出
        callApi('verifyCode', { account: accountToVerify, code: code })
                .then(res => { /* ... */ })
                .catch(err => {
                    // ▼▼▼ 【核心修改】 ▼▼▼
                    if (err.message.includes('過期')) {
                        msgDiv.innerText = '驗證碼已過期，請點擊下方的「重新寄送」按鈕獲取新碼。';
                    } else {
                        msgDiv.innerText = err.message;
                    }
                    // ▲▲▲ 【核心修改】 ▲▲▲
                });
        }

    function showProfile() { showCustomAlert("會員資料功能正在升級中。"); }
    function hideProfile() {}
    function saveProfile() {}
    function showAdminPanel() {}
    function hideAdminPanel() {}
    function loadSerialCodes() {}
    function addSerialRow() {}
    function deleteSerialRow() {}
    function saveSerialCodes() {}
    function showUserAdminPanel() {}
    function hideUserAdminPanel() {}
    function loadUsersForAdmin() {}
    function saveUsersByAdmin() {}
    
    // ▼▼▼ 第二部分：事件綁定 ▼▼▼
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('loginBtn').addEventListener('click', login);
        document.getElementById('registerBtn').addEventListener('click', register);
        document.getElementById('barcodeForm').addEventListener('submit', function(event) { event.preventDefault(); handleGenerateClick(); });
        document.getElementById('downloadAllBtn').addEventListener('click', startDownloadProcess);
        document.getElementById('backToGeneratorBtn').addEventListener('click', showMainAppPage);
        document.getElementById('showRegisterBtn').addEventListener('click', showRegister);
        document.getElementById('registerBackToLoginBtn').addEventListener('click', showLogin);
        document.getElementById('showForgotBtn').addEventListener('click', showForgotBox);
        document.getElementById('forgotBackBtn').addEventListener('click', hideForgotBox);
        document.getElementById('forgotSendBtn').addEventListener('click', forgotPassword);
        document.getElementById('verifyBtn').addEventListener('click', verifyCode);
        document.getElementById('resendCodeBtn').addEventListener('click', resendCode);
        document.getElementById('verifyBackToLoginBtn').addEventListener('click', showLogin);
        document.getElementById('showProfileBtn').addEventListener('click', showProfile);
        document.getElementById('saveProfileBtn').addEventListener('click', saveProfile);
        document.getElementById('cancelProfileBtn').addEventListener('click', hideProfile);
        document.getElementById('adminBtn').addEventListener('click', showAdminPanel);
        document.getElementById('cancelAdminBtn').addEventListener('click', hideAdminPanel);
        document.getElementById('addRowBtn').addEventListener('click', addSerialRow);
        document.getElementById('saveSerialsBtn').addEventListener('click', saveSerialCodes);
        document.getElementById('serialTableBody').addEventListener('click', function(event) { if (event.target.classList.contains('delete-row-btn')) { deleteSerialRow(event.target); } });
        document.getElementById('userAdminBtn').addEventListener('click', showUserAdminPanel);
        document.getElementById('saveUsersBtn').addEventListener('click', saveUsersByAdmin);
        document.getElementById('cancelUserAdminBtn').addEventListener('click', hideUserAdminPanel);
        document.getElementById('bankSelect').addEventListener('change', onBankSelectChange);
        document.getElementById('qrCount').addEventListener('change', updateButtonLabels);
        document.getElementById('amountIncrementType').addEventListener('change', function() {
            document.getElementById('customIncrementAmount').style.display = (this.value === 'custom') ? 'block' : 'none';
        });
        
        // --- 初始載入 ---
        loadBankSelect();
        setQrCountOptions(); // 預先填充數量選項
        updateButtonLabels();
    });
  </script>
</body>
</html>